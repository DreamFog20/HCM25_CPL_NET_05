@model MovieTheater.ViewModels.MovieDetailViewModel
@using System.Security.Claims

@{
    ViewData["Title"] = "Edit Movie";
    var userRole = User.FindFirst(ClaimTypes.Role)?.Value;
}

<link rel="stylesheet" href="~/css/movieedit.css" asp-append-version="true" />

<div class="signup-wrapper">
    <div class="signup-card">
        @if (userRole == "Admin")
        {
            <a asp-controller="Admin" asp-action="MainPage" asp-route-tab="MovieMg" class="btn btn-secondary">
                &larr; Return
            </a>
        }
        else
        {
            <a asp-controller="Employee" asp-action="MainPage" asp-route-tab="MovieMg" class="btn btn-secondary">
                &larr; Return
            </a>
        }

		<h2 class="signup-title">Movie Edit</h2>
        <form asp-controller="Movie" asp-action="Edit" asp-route-id="@Model.MovieId" method="post" enctype="multipart/form-data">
            <input type="hidden" asp-for="MovieId" />
            <div asp-validation-summary="All" class="text-danger"></div>

            <div class="row">   
                <!-- Left Column: Image Uploads -->
                <div class="col">
                    <div class="form-group mb-3">
                        <strong>Small Image:</strong><br />
                        @if (!string.IsNullOrEmpty(Model.SmallImage))
                        {
                            <img id="smallImagePreview" src="@Url.Content(Model.SmallImage)" alt="@Model.MovieNameEnglish" width="200" height="250" style="display:block; margin-bottom:10px;" />
                        }
                        else
                        {
                            <img id="smallImagePreview" src="#" alt="No image" width="200" height="250" style="display:none; margin-bottom:10px;" />
                        }
                        <input type="file" class="form-control" asp-for="SmallImageFile" onchange="previewImage(this, 'smallImagePreview')" />
                        <span asp-validation-for="SmallImageFile" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <strong>Large Image:</strong><br />
                        @if (!string.IsNullOrEmpty(Model.LargeImage))
                        {
                            <img id="largeImagePreview" src="@Url.Content(Model.LargeImage)" alt="@Model.MovieNameEnglish" width="200" height="250" style="display:block; margin-bottom:10px;" />
                        }
                        else
                        {
                            <img id="largeImagePreview" src="#" alt="No image" width="200" height="250" style="display:none; margin-bottom:10px;" />
                        }
                        <input type="file" class="form-control" asp-for="LargeImageFile" onchange="previewImage(this, 'largeImagePreview')" />
                        <span asp-validation-for="LargeImageFile" class="text-danger"></span>
                    </div>
                </div>

                <!-- Right Column: Movie Details -->
                <div class="col-md-6">
                    <div class="form-group mb-3">
                        <strong>Movie Name (EN):</strong>
                        <input type="text" class="form-control" asp-for="MovieNameEnglish" />
                        <span asp-validation-for="MovieNameEnglish" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <strong>Movie Name (VN):</strong>
                        <input type="text" class="form-control" asp-for="MovieNameVn" />
                        <span asp-validation-for="MovieNameVn" class="text-danger"></span>
                    </div>

                    <div class="row mb-3">
                        <div class="col">
                            <strong>From Date:</strong>
                            <input type="date" class="form-control" asp-for="FromDate" />
                            <span asp-validation-for="FromDate" class="text-danger"></span>
                        </div>
                        <div class="col">
                            <strong>To Date:</strong>
                            <input type="date" class="form-control" asp-for="ToDate" />
                            <span asp-validation-for="ToDate" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <strong>Actor:</strong>
                        <input type="text" class="form-control" asp-for="Actor" />
                        <span asp-validation-for="Actor" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <strong>Production Company:</strong>
                        <input type="text" class="form-control" asp-for="MovieProductionCompany" />
                        <span asp-validation-for="MovieProductionCompany" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <strong>Director:</strong>
                        <input type="text" class="form-control" asp-for="Director" />
                        <span asp-validation-for="Director" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <strong>Duration:</strong>
                        <input type="number" class="form-control" asp-for="Duration" />
                        <span asp-validation-for="Duration" class="text-danger"></span>
                        @if (TempData["ErrorMessage"] != null)
                        {
                            <div class="alert alert-danger mt-2 mb-0 p-2 text-center">
                                @TempData["ErrorMessage"]
                            </div>
                        }
                    </div>

                    <div class="form-group mb-3">
                        <strong>Version:</strong><br />
                        @foreach (var version in Model.AvailableVersions)
                        {
                            <label class="me-3">
                                <input type="checkbox"
                                       name="SelectedVersionIds"
                                       value="@version.VersionId"
                                       @(Model.SelectedVersionIds.Contains(version.VersionId) ? "checked" : "") />
                                @version.VersionName
                            </label>
                        }
                        <span asp-validation-for="SelectedVersionIds" class="text-danger"></span>
                    </div>

                    <div class="form-group mb-3">
                        <strong>Types</strong><br />
                        @foreach (var type in Model.AvailableTypes)
                        {
                            <label class="me-3">
                                <input type="checkbox"
                                       name="SelectedTypeIds"
                                       value="@type.TypeId"
                                       @(Model.SelectedTypeIds.Contains(type.TypeId) ? "checked" : "") />
                                @type.TypeName
                            </label>
                        }
                    </div>
                </div>
            </div>

            <!-- Full-width description row below columns -->
            <div class="form-group mt-3">
                <strong>Movie Description / Content</strong>
                <textarea class="form-control" asp-for="Content"></textarea>
                <span asp-validation-for="Content" class="text-danger"></span>
            </div>

            <h2 class="signup-title">Movie Trailer</h2>
            <div class="form-group mt-3">
                <strong>Trailer URL</strong>
                <input type="url" class="form-control" asp-for="TrailerUrl" />
                <span asp-validation-for="TrailerUrl" class="text-danger"></span>

                @if (!string.IsNullOrWhiteSpace(Model.TrailerUrl))
                {
                    <div class="video-container mb-4">
                        <iframe src="@Model.TrailerUrl" frameborder="0" allowfullscreen></iframe>
                    </div>
                }
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary px-4 py-2 rounded">Edit Movie</button>
            </div>
        </form>
    </div>
</div>

<script>
    function previewImage(input, previewId) {
        var preview = document.getElementById(previewId);
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                preview.src = e.target.result;
                preview.style.display = "block";
            }
            reader.readAsDataURL(input.files[0]);
        } else {
            preview.src = "#";
            preview.style.display = "none";
        }
    }
</script>
