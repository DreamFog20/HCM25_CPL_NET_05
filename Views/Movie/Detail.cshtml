@model MovieTheater.ViewModels.MovieDetailViewModel
@using System.Security.Claims

@{
    ViewData["Title"] = "Movie Detail";
    var isAuthenticated = User.Identity.IsAuthenticated;
    var movieList = ViewBag.MovieList as List<MovieTheater.Models.Movie>;
    var selectedMovieId = ViewBag.SelectedMovieId as string;
    var showsByDate = ViewBag.ShowsByDate as Dictionary<string, List<string>>;
}


<div class="container-fluid px-4 py-3" style="font-size: 20px">
    <div class="mb-3">
        <a asp-controller="Movie" asp-action="MovieList" class="btn btn-outline-secondary">
            &larr; Return
        </a>
    </div>

    <div class="row">
        <!-- Left Column: Movie Poster -->
        <div class="col-md-6 text-end">
            <img id="smallImagePreview" src="@Url.Content(Model.SmallImage)" alt="@Model.MovieNameEnglish" class="img-fluid rounded shadow-sm" style="width: 55%; object-fit: cover; margin-right: 5rem" />
        </div>

        <!-- Right Column: Movie Details -->
        <div class="col-md-6 d-flex align-items-center">
            <div style="font-size: 20px">
                <!-- Title and Director -->
                <span class="mb-4" style="font-size: 60px; font-family: 'Segoe UI'; font-weight: bold; margin-right: 20px">@Model.MovieNameEnglish</span>
                <h5 class="text-muted mb-4">
                    by @Html.Raw(string.Join(", ", Model.People?.Where(p => p.IsDirector == true).Select(d =>
                                        $"<a href='javascript:void(0);' class='person-link' " +
                                        $"data-name='{d.Name}' " +
                                        $"data-dob='{d.DateOfBirth?.ToString("yyyy-MM-dd") ?? ""}' " +
                                        $"data-nationality='{d.Nationality}' " +
                                        $"data-id='{d.PersonId}' " +
                                        $"data-gender='{d.Gender}' " +
                                        $"data-description='{d.Description}' " +
                                        $"data-image='{Url.Content(d.Image)}'>" +
                                        $"<u>{d.Name}</u></a>") ?? new[] { "<u>Unknown Director</u>" }))
                </h5>

                <!-- Versions and Types -->
                <div class="mb-4">
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var version in Model.AvailableVersions)
                        {
                            <span class="badge bg-secondary" style="border-radius: 20px">@version.VersionName</span>
                        }
                        @foreach (var type in Model.AvailableTypes)
                        {
                            <span class="badge" style="border-radius: 20px; border: 1px solid black; color: black;">@type.TypeName</span>
                        }
                    </div>
                </div>

                <!-- Duration and Year -->
                <div class="mb-4">
                    <span class="text-muted">
                        @Model.Duration min ‚Ä¢ @(Model.FromDate?.Year ?? DateTime.Now.Year)
                    </span>
                </div>

                <!-- Actors Images -->
                @if (Model.People?.Any(p => p.IsDirector == false) == true)
                {
                    <div class="mb-4">
                        <div class="d-flex flex-wrap gap-3">
                            @foreach (var actor in Model.People.Where(p => p.IsDirector == false))
                            {
                                <div class="director-image-container text-center">
                                    <a href="javascript:void(0);" class="person-link"
                                       data-name="@actor.Name" data-id="@actor.PersonId"
                                       data-dob="@(actor.DateOfBirth?.ToString("yyyy-MM-dd") ?? "")"
                                       data-nationality="@actor.Nationality"
                                       data-gender="@actor.Gender"
                                       data-description="@actor.Description"
                                       data-image="@actor.Image">
                                        <img src="@Url.Content(actor.Image)" alt="@actor.Name"
                                             class="rounded-circle shadow-sm"
                                             style="width: 60px; height: 60px; object-fit: cover;" />
                                    </a>
                                    <p class="small text-muted mt-2 mb-0">@actor.Name</p>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Description -->
                <div class="mb-4">
                    <p class="text-justify" style="line-height: 1.6; width: 80%">@Model.Content</p>
                </div>

                <div class="row mb-4 me-2" style="width: 80%">
                    <div class="col-md-6 text-end" id="bookSection">
                        <button type="button" class="btn btn-primary btn-lg" style="width: 200px; border-radius: 20px" data-bs-toggle="modal" data-bs-target="#addBookingModal">
                            Book Tickets
                        </button>
                    </div>
                    <div class="col-md-6 text-start">
                        <button class="btn btn-outline-primary btn-lg" style="width: 200px; border-radius: 20px" data-bs-toggle="modal" data-bs-target="#trailerModal">
                            Watch Trailer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule -->
    <div class="mb-4" id="scheduleSection" style="margin-left: 15rem; margin-top: 3rem">
        <h2 class="mb-3">Schedule</h2>
        <div id="movieShowsContainer" class="schedule-container">
            <!-- Dynamic movie shows will appear here -->
        </div>
    </div>


    <!-- Booking Button -->
    @if (!isAuthenticated)
    {
        <div class="alert alert-warning text-center mt-5 mx-auto" role="alert" style="width: 500px">
            Please log in to book your tickets.
        </div>
    }
</div>

<!-- Pass data from Razor to JavaScript -->
<script>
    // Set global variables for the JavaScript file to use
    window.movieId = '@Model.MovieId';
    window.isAuthenticated = @User.Identity.IsAuthenticated.ToString().ToLower();
    window.showsByDate = @Html.Raw(Json.Serialize(showsByDate));
</script>

<!-- Include the JavaScript file -->
<script src="~/js/movie-detail.js" asp-append-version="true"></script>

<div class="modal fade" id="trailerModal" tabindex="-1" aria-labelledby="trailerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body" style="background-color: black">
                @if (!string.IsNullOrWhiteSpace(Model.TrailerUrl))
                {
                    <div class="ratio ratio-16x9">
                        <iframe src="@Model.TrailerUrl" frameborder="0" allowfullscreen></iframe>
                    </div>
                }
                else
                {
                    <div class="text-muted">Trailer not available.</div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Actor Info Modal -->
<div class="modal fade" id="actorModal" tabindex="-1" aria-labelledby="actorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px">
            <div class="modal-body" id="actorModalBody">
                <!-- Actor details will be injected here -->
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addBookingModal" tabindex="-1" aria-labelledby="addBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBookingModalLabel">
                    <i class="fas fa-ticket-alt me-2"></i>Book Your Ticket
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" novalidate>
                    <input type="hidden" id="movieId" name="movieId" value="@Model.MovieId" />
                    <div class="mb-4">
                        <label for="dateSelect" class="form-label booking-label"><span class="label-icon">üóìÔ∏è</span> <strong>Date</strong></label>
                        <select id="dateSelect" class="form-select booking-select" onchange="updateVersions()">
                            <option value="">‚Äî Select Date ‚Äî</option>
                            <!-- Dates will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="versionSelect" class="form-label booking-label"><span class="label-icon">üéûÔ∏è</span> <strong>Version</strong></label>
                        <select id="versionSelect" class="form-select booking-select" disabled onchange="updateTimes()">
                            <option value="">‚Äî Select Version ‚Äî</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="timeSelect" class="form-label booking-label"><span class="label-icon">‚è∞</span> <strong>Time</strong></label>
                        <select id="timeSelect" class="form-select booking-select" disabled>
                            <option value="">‚Äî Select Time ‚Äî</option>
                        </select>
                    </div>
                    <button type="button" id="bookBtn" class="btn booking-btn-gradient w-100 mt-2" onclick="continueToSeats()">
                        <span>Continue to Seat Selection</span> <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
