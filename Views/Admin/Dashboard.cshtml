@model MovieTheater.ViewModels.AdminDashboardViewModel
@using System.Globalization
@using Newtonsoft.Json
<link rel="stylesheet" href="~/css/dashboard.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- Store dashboard data for chart initialization -->
<script id="dashboard-data" type="application/json">
    @Html.Raw(JsonConvert.SerializeObject(new {
                                RevenueTrendDates = Model.RevenueTrendDates,
                                RevenueTrendValues = Model.RevenueTrendValues,
                                BookingTrendDates = Model.BookingTrendDates,
                                BookingTrendValues = Model.BookingTrendValues,
                                VoucherTrendValues = Model.VoucherTrendValues,
                                TopMovies = Model.TopMovies,
                                TopMembers = Model.TopMembers,
                                FoodAnalytics = Model.FoodAnalytics
                }))
</script>

<div class="container-fluid mt-4">
    <h2 class="mb-4">🎬 Admin Dashboard</h2>

    <!-- Tab Switcher and Actions Row -->
    <div class="d-flex align-items-center justify-content-between mb-4">
        <div>
            <button id="tab-movie" class="dashboard-tab" onclick="showTab('movie')"><i class="bi bi-film"></i> Movie Stats</button>
            <button id="tab-food" class="dashboard-tab" onclick="showTab('food')"><i class="bi bi-cup-straw"></i> Food Stats</button>
        </div>
        <div class="dashboard-actions">
            <button id="download-charts-btn" class="btn btn-outline-light"><i class="bi bi-image"></i> Download Charts</button>
            <button class="btn btn-warning" onclick="window.print()"><i class="bi bi-printer"></i> Print Report</button>
        </div>
    </div>



    <div id="movie-dashboard">
        <!-- Row 1: Core KPIs (4 cards in one row) -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-gradient-primary h-100 shadow">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-cash-coin"></i> Gross Ticket Revenue</h5>
                        <p class="display-6">@Model.GrossRevenue.ToString("#,##0", new System.Globalization.CultureInfo("vi-VN")) đ</p>
                        <p class="small-stat">
                            Today: @Model.RevenueToday.ToString("#,##0", new System.Globalization.CultureInfo("vi-VN")) đ
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-gradient-danger h-100 shadow">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-ticket-perforated"></i> Vouchers Issued</h5>
                        <p class="display-6">@Model.TotalVouchersIssued.ToString("#,##0", new System.Globalization.CultureInfo("vi-VN")) đ</p>
                        <p class="small-stat">
                            Today: @Model.VouchersToday.ToString("#,##0", new System.Globalization.CultureInfo("vi-VN")) đ
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-gradient-success h-100 shadow">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-currency-dollar"></i> Net Ticket Revenue</h5>
                        <p class="display-6">@Model.NetRevenue.ToString("#,##0", new System.Globalization.CultureInfo("vi-VN")) đ</p>
                        <p class="small-stat">
                            Today: @Model.NetRevenueToday.ToString("#,##0", new System.Globalization.CultureInfo("vi-VN")) đ
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-warning h-100 shadow">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-calendar-check"></i> Total Bookings</h5>
                        <p class="display-6">@Model.TotalBookings</p>
                        <p class="small-stat">
                            Today: @Model.BookingsToday
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Main Analytics (70% + 30% split) -->
        <div class="row mb-5">
            <div class="col-md-8">
                <div class="card shadow h-100">
                    <div class="card-body p-3">
                        <h5><i class="bi bi-bar-chart-line"></i> Bookings & Revenue </h5>
                        <canvas id="movieComboChart" class="dashboard-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow h-100">
                    <div class="card-body p-3">
                        <h5 class="mb-3"><i class="bi bi-speedometer2"></i> Key Metrics</h5>

                        <!-- Tickets Sold Today -->
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                            <div>
                                <i class="bi bi-ticket-perforated text-warning"></i>
                                <span class="ms-2">Tickets Sold Today</span>
                            </div>
                            <span class="badge bg-warning text-dark fs-6">@Model.TicketsSoldToday</span>
                        </div>

                        <!-- Occupancy Rate -->
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                            <div>
                                <i class="bi bi-graph-up text-info"></i>
                                <span class="ms-2">Occupancy Rate</span>
                            </div>
                            <span class="badge bg-info fs-6">@Model.OccupancyRateToday.ToString("F1")%</span>
                        </div>

                        <!-- Cancel Rate -->
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-light rounded">
                            <div>
                                <i class="bi bi-x-circle text-danger"></i>
                                <span class="ms-2">Cancel Rate</span>
                            </div>
                            <span class="badge bg-danger fs-6">
                                @{
                                    var todayCancellations = Model.MovieAnalytics?.RecentCancellations?.Count(c => c.ActivityDate.Date == DateTime.Today) ?? 0;
                                    var totalBookingsToday = Model.BookingsToday + todayCancellations; // Total bookings made today (including cancelled)
                                    var cancelRate = totalBookingsToday > 0 ? (todayCancellations * 100.0 / totalBookingsToday) : 0.0;
                                }
                                @cancelRate.ToString("F1")%
                            </span>
                        </div>

                        <!-- Average Ticket Price -->
                        <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                            <div>
                                <i class="bi bi-currency-exchange text-success"></i>
                                <span class="ms-2">Avg. Ticket Price</span>
                            </div>
                            <span class="badge bg-success fs-6">@(Model.TicketsSoldToday > 0 ? (Model.RevenueToday / Model.TicketsSoldToday).ToString("N0") : "0") đ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Performance Insights (50% + 50% split) -->
        <div class="row mb-5">
            <div class="col-md-6">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5><i class="bi bi-film"></i> Top 5 Movies</h5>
                        <canvas id="topMoviesChart" class="dashboard-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5><i class="bi bi-people-fill"></i> Top 5 Members</h5>
                        <canvas id="topMembersChart" class="dashboard-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: Recent Activity (100% width) -->
        <div class="row mb-5">
            <div class="col-md-8">
                <div class="card shadow h-100">
                    <div class="card-body d-flex flex-column p-3">
                        <h5><i class="bi bi-film"></i> Recent Movie Activity</h5>
                        <div class="btn-group w-100 mb-3" role="group" aria-label="Movie activity tabs">
                            <button type="button" class="btn btn-primary active" id="booked-btn" onclick="switchMovieTab('booked')">Booked</button>
                            <button type="button" class="btn btn-primary" id="cancelled-btn" onclick="switchMovieTab('cancelled')">Cancelled</button>
                        </div>
                        <div class="tab-content flex-fill dashboard-recent-list">
                            <div class="tab-pane fade show active" id="booked-list" role="tabpanel">
                                @foreach (var b in Model.MovieAnalytics.RecentBookings.Take(6))
                                {
                                    <div class="recent-list-item d-flex flex-column mb-2 p-2 bg-light rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>🎟️ <strong>@b.MovieName</strong></span>
                                            <span class="text-muted small">@b.ActivityDate.ToString("MM-dd HH:mm")</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                            <span>Member: <span class="text-info">@b.MemberName</span></span>
                                            <span>Total: <span class="fw-bold">@b.TotalAmount.ToString("N0") đ</span></span>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="tab-pane fade" id="cancelled-list" role="tabpanel">
                                @foreach (var c in Model.MovieAnalytics.RecentCancellations.Take(6))
                                {
                                    <div class="recent-list-item d-flex flex-column mb-2 p-2 bg-light rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>🚫 <strong>@c.MovieName</strong></span>
                                            <span class="text-muted small">@c.ActivityDate.ToString("MM-dd HH:mm")</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                            <span>Member: <span class="text-info">@c.MemberName</span></span>
                                            <span>Refund: <span class="fw-bold text-danger">@c.TotalAmount.ToString("N0") đ</span></span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5><i class="bi bi-person-plus"></i> New Members (Last 5)</h5>
                        <div class="list-group list-group-flush">
                            @foreach (var m in Model.RecentMembers)
                            {
                                <div class="list-group-item px-0 py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong class="text-primary">@m.FullName</strong>
                                            <br>
                                            <small class="text-muted">@m.Email</small>
                                        </div>
                                        <small class="text-muted">@m.JoinDate?.ToString("MM-dd")</small>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div id="food-dashboard" style="display:none;">
        <!-- 1) KPI Cards Row (Food Stats) -->
        <div class="row mb-4 align-items-stretch">
            <!-- 1) Gross Revenue -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-gradient-primary shadow h-100">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-cash-coin"></i> Gross Food Revenue</h5>
                        <p class="display-6">
                            @Model.FoodAnalytics.GrossRevenue.ToString("#,##0", new System.Globalization.CultureInfo("vi-VN")) đ
                        </p>
                        <p class="small-stat">
                            Today: @Model.FoodAnalytics.GrossRevenueToday.ToString("#,##0", new System.Globalization.CultureInfo("vi-VN")) đ
                        </p>
                    </div>
                </div>
            </div>

            <!-- 2) Vouchers Issued -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-gradient-danger h-100 shadow">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-ticket-perforated"></i> Vouchers Issued</h5>
                        <p class="display-6">
                            @Model.FoodAnalytics.VouchersIssued.ToString("N0", CultureInfo.GetCultureInfo("en-US")) đ
                        </p>
                        <p class="small-stat">
                            Today: @Model.FoodAnalytics.VouchersToday.ToString("N0", CultureInfo.GetCultureInfo("en-US")) đ
                        </p>
                    </div>
                </div>
            </div>

            <!-- 3) Net Revenue -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-gradient-success h-100 shadow">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-currency-dollar"></i> Net Revenue</h5>
                        <p class="display-6">
                            @Model.FoodAnalytics.NetRevenue.ToString("N0", CultureInfo.GetCultureInfo("en-US")) đ
                        </p>
                        <p class="small-stat">
                            Today: @Model.FoodAnalytics.NetRevenueToday.ToString("N0", CultureInfo.GetCultureInfo("en-US")) đ
                        </p>
                    </div>
                </div>
            </div>

            <!-- 4) Orders -->
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card text-white bg-warning h-100 shadow">
                    <div class="card-body text-center">
                        <h5><i class="bi bi-receipt"></i> Orders</h5>
                        <p class="display-6">@Model.FoodAnalytics.TotalOrders</p>
                        <p class="small-stat">
                            Today: @Model.FoodAnalytics.OrdersToday
                        </p>
                    </div>
                </div>
            </div>
        </div>


        <!-- 2) Revenue & Orders by Day and Recent Food Activity side by side -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5><i class="bi bi-bar-chart-line"></i> Orders & Revenue </h5>
                        <canvas id="foodComboChart" class="dashboard-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow h-100">
                    <div class="card-body d-flex flex-column p-3">
                        <h5><i class="bi bi-egg-fried"></i> Recent Food Activity</h5>
                        <div class="btn-group w-100 mb-3" role="group" aria-label="Food activity tabs">
                            <button type="button" class="btn btn-primary active" id="orders-btn" onclick="switchTab('orders')">Orders</button>
                            <button type="button" class="btn btn-primary" id="cancels-btn" onclick="switchTab('cancels')">Cancels</button>
                        </div>
                        <div class="tab-content flex-fill dashboard-recent-list">
                            <div class="tab-pane fade show active" id="orders-list" role="tabpanel">
                                @foreach (var o in Model.FoodAnalytics.RecentOrders.Take(8))
                                {
                                    <div class="recent-list-item d-flex flex-column mb-2 p-2 bg-light rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>🍽️ <strong>@o.FoodName</strong> <span class="badge bg-primary ms-2">@($"x{o.Quantity}")</span></span>
                                            <span class="text-muted small">@o.Date.ToString("MM-dd HH:mm")</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                            <span>Price: <span class="text-warning">@o.Price.ToString("N0") đ</span></span>
                                            <span>Total: <span class="fw-bold">@o.OrderTotal.ToString("N0") đ</span></span>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="tab-pane fade" id="cancels-list" role="tabpanel">
                                @foreach (var c in Model.FoodAnalytics.RecentCancels)
                                {
                                    <div class="recent-list-item d-flex flex-column mb-2 p-2 bg-light rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>❌ <strong>@c.FoodName</strong> <span class="badge bg-danger ms-2">@($"x{c.Quantity}")</span></span>
                                            <span class="text-muted small">@c.Date.ToString("MM-dd HH:mm")</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-1">
                                            <span>Price: <span class="text-warning">@c.Price.ToString("N0") đ</span></span>
                                            <span>Total: <span class="fw-bold">@c.OrderTotal.ToString("N0") đ</span></span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 3) Sales by Category and Food Items by Category side by side -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5><i class="bi bi-pie-chart"></i> Sales by Category</h5>
                        <canvas id="foodCategoryPie" class="dashboard-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card shadow h-100">
                    <div class="card-body">
                        <h5><i class="bi bi-bar-chart"></i> Food Items by Category</h5>
                        <canvas id="foodItemsByCategoryBar" class="dashboard-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4) Sales by Hour Full‑Width -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-5">
                    <div class="card-body">
                        <h5><i class="bi bi-graph-up"></i> Sales by Hour</h5>
                        <canvas id="foodHourHeatmap" class="dashboard-chart-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="~/js/dashboard.js" asp-append-version="true"></script>
