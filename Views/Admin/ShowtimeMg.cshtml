@model MovieTheater.ViewModels.ShowtimeManagementViewModel

<link rel="stylesheet" href="/css/showtime.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<h2 class="text-center">Showtime Management</h2>

<div class="container-fluid">
	<div class="row">
	<!-- Movie Shows Table (Left Column) -->
        <div class="col-lg-3">
            <div class="selected-date-display text-center mb-2">
                <strong>Selected date:</strong>
                @Model.SelectedDate
            </div>
            <div class="showtime-list">
                @if (Model.MovieShows == null || !Model.MovieShows.Any())
                {
                    <div class="alert alert-warning text-center">No showtime</div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <thead class="table-dark">
                                <tr class="text-center">
                                    <th>Movie</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Screen</th>
                                </tr>
                            </thead>
                            <tbody id="showtimeTableBody">
                                @foreach (var show in Model.MovieShows)
                                {
                                    <tr>
                                        <td>@show.Movie?.MovieNameEnglish</td>
                                        <td class="text-center">@show.ShowDate.ToString("dd MMM yyyy")</td>
                                        <td class="text-center">
                                            @{
                                                var start = show.Schedule?.ScheduleTime;
                                                var duration = show.Movie?.Duration ?? 0;
                                                string timeDisplay = "";
                                                if (start != null && duration > 0)
                                                {
                                                    var end = start.Value.AddMinutes(duration);
                                                    timeDisplay = $"[{start:HH\\:mm} ~ {end:HH\\:mm}]";
                                                }
                                                else if (start != null)
                                                {
                                                    timeDisplay = $"[{start:HH\\:mm}]";
                                                }
                                                @timeDisplay
                                            }
                                        </td>
                                        <td class="text-center">@show.CinemaRoom?.CinemaRoomName</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <nav>
                        <ul class="pagination justify-content-center" id="showtime-pagination">
                        </ul>
                    </nav>
                }
            </div>
        </div>

        <!-- Calendar Section (Right Column) -->
        <div class="col-lg-9">
            <div class="calendar-section">
                <form method="get" asp-action="ShowtimeMg" asp-controller="Admin" class="mb-4 text-center" id="dateNavForm">
                    <input type="hidden" id="calendarInput" name="date" value="@Model.SelectedDate.ToString("dd/MM/yyyy")" />
                    <div id="calendarNav" class="mb-2 d-flex justify-content-center align-items-center">
                        <button type="button" id="prevMonth" class="btn btn-outline-secondary btn-sm me-2"><i class="fa fa-chevron-left"></i></button>
                        <span id="calendarMonthYear" class="fw-bold"></span>
                        <button type="button" id="nextMonth" class="btn btn-outline-secondary btn-sm ms-2"><i class="fa fa-chevron-right"></i></button>
                    </div>
                    <div id="customCalendar"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function pad(n) { return n < 10 ? '0' + n : n; }

// Month names for display
const monthNames = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
];

let selected = '@Model.SelectedDate.ToString("yyyy-MM-dd")';
let selectedDate = selected ? new Date(selected) : new Date();
let currentYear = selectedDate.getFullYear();
let currentMonth = selectedDate.getMonth();

// Object to store fetched movie data
var movieShowSummary = {};
// Keep track of which months have been fetched
let fetchedMonths = {};

// Initial data load from ViewBag
@{
    var initialSummary = ViewBag.MovieShowSummaryByDate as Dictionary<DateOnly, List<string>>;
    if (initialSummary != null && initialSummary.Any())
    {
        foreach (var kvp in initialSummary)
        {
            <text>movieShowSummary['@kvp.Key.ToString("yyyy-MM-dd")'] = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(kvp.Value));</text>
        }
        // Mark the initial month as fetched
        <text>fetchedMonths[`${currentYear}-${currentMonth}`] = true;</text>
    }
}

function renderCalendar(year, month, selectedDate) {
    const calendar = document.getElementById('customCalendar');
    calendar.innerHTML = '';
    const today = new Date();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1; // Monday start
    let html = '<table class="table table-bordered text-center"><thead><tr>';
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => html += `<th>${d}</th>`);
    html += '</tr></thead><tbody><tr>';
    for (let i = 0; i < startDay; i++) html += '<td></td>';
    for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateObj = new Date(year, month, d);
        const isToday = dateObj.toDateString() === today.toDateString();
        const isSelected = selectedDate && dateObj.toDateString() === selectedDate.toDateString();
        let classes = '';
        if (isToday) classes += ' bg-info';
        if (isSelected) classes += ' bg-primary text-white';

        // Format date key as yyyy-MM-dd
        const key = `${year}-${pad(month+1)}-${pad(d)}`;
        let movieInfo = '';
        let uniqueMovieNames = movieShowSummary[key];
        if (typeof uniqueMovieNames === 'string') {
            try { uniqueMovieNames = JSON.parse(uniqueMovieNames); } catch (e) { uniqueMovieNames = []; }
        }
        if (!Array.isArray(uniqueMovieNames)) uniqueMovieNames = [];
        console.log(key, uniqueMovieNames, uniqueMovieNames.length); // Debug log
        if (uniqueMovieNames.length > 0) {
            let movieList = uniqueMovieNames.slice(0,2).map(name => `<div class='calendar-movie-title'>${name}</div>`).join('');
            if (uniqueMovieNames.length > 2) {
                movieList += `<div class='calendar-movie-more'>+${uniqueMovieNames.length - 2}</div>`;
            }
            movieInfo = `<div class='calendar-movies'>${movieList}</div>`;
        }

        html += `<td class="calendar-day${classes}" data-date="${pad(d)}/${pad(month+1)}/${year}">` +
            `<div class='calendar-date-number'>${d}</div>${movieInfo}</td>`;
        if ((startDay + d) % 7 === 0) html += '</tr><tr>';
    }
    html += '</tr></tbody></table>';
    calendar.innerHTML = html;

    // Add click listeners
    document.querySelectorAll('.calendar-day').forEach(cell => {
        cell.onclick = function() {
            document.getElementById('calendarInput').value = this.getAttribute('data-date');
            document.getElementById('dateNavForm').submit();
        };
    });

    // Update month/year display
    document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
}

function navigateToMonth(year, month) {
    const monthKey = `${year}-${month}`;

    // If we already have the data for this month, just render the calendar
    if (fetchedMonths[monthKey]) {
        renderCalendar(year, month, selectedDate);
        return;
    }

    // Otherwise, fetch the data from the server
    fetch(`/Admin/GetMovieShowSummary?year=${year}&month=${month + 1}`) // JS month is 0-11, server expects 1-12
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Add the new data to our summary object and mark the month as fetched
            Object.assign(movieShowSummary, data);
            fetchedMonths[monthKey] = true;
            // Now render the calendar with the new data
            renderCalendar(year, month, selectedDate);
        })
        .catch(error => {
            console.error('Error fetching movie summary:', error);
            // Even if fetching fails, render the calendar so the UI doesn't get stuck
            renderCalendar(year, month, selectedDate);
        });
}

// Initial render
renderCalendar(currentYear, currentMonth, selectedDate);

// Update click handlers to use the new navigation function
document.getElementById('prevMonth').onclick = function() {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    navigateToMonth(currentYear, currentMonth);
};

document.getElementById('nextMonth').onclick = function() {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    navigateToMonth(currentYear, currentMonth);
};

document.addEventListener('DOMContentLoaded', function() {
    const tableBody = document.getElementById('showtimeTableBody');
    if (!tableBody) return;

    const rows = Array.from(tableBody.querySelectorAll('tr'));
    const rowsPerPage = 7;
    const pageCount = Math.ceil(rows.length / rowsPerPage);
    const paginationContainer = document.getElementById('showtime-pagination');

    if (pageCount <= 1) {
        if (paginationContainer) {
            paginationContainer.style.display = 'none';
        }
        return;
    }

    let currentPage = 1;

    function displayPage(page) {
        currentPage = page;
        tableBody.innerHTML = '';

        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedRows = rows.slice(start, end);

        paginatedRows.forEach(row => {
            tableBody.appendChild(row);
        });

        updatePaginationControls();
    }

    function updatePaginationControls() {
        if (!paginationContainer) return;
        paginationContainer.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = 'page-item';
        if (currentPage === 1) prevLi.classList.add('disabled');
        const prevLink = document.createElement('a');
        prevLink.className = 'page-link';
        prevLink.href = '#';
        prevLink.innerHTML = '&laquo;';
        prevLink.onclick = (e) => {
            e.preventDefault();
            if (currentPage > 1) displayPage(currentPage - 1);
        };
        prevLi.appendChild(prevLink);
        paginationContainer.appendChild(prevLi);

        // Page number buttons
        for (let i = 1; i <= pageCount; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = 'page-item';
            if (i === currentPage) pageLi.classList.add('active');

            const pageLink = document.createElement('a');
            pageLink.className = 'page-link';
            pageLink.href = '#';
            pageLink.innerText = i;
            pageLink.onclick = (e) => {
                e.preventDefault();
                displayPage(i);
            };
            pageLi.appendChild(pageLink);
            paginationContainer.appendChild(pageLi);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = 'page-item';
        if (currentPage === pageCount) nextLi.classList.add('disabled');
        const nextLink = document.createElement('a');
        nextLink.className = 'page-link';
        nextLink.href = '#';
        nextLink.innerHTML = '&raquo;';
        nextLink.onclick = (e) => {
            e.preventDefault();
            if (currentPage < pageCount) displayPage(currentPage + 1);
        };
        nextLi.appendChild(nextLink);
        paginationContainer.appendChild(nextLi);
    }

    displayPage(1);
});
</script>
