@model IEnumerable<MovieTheater.Models.Invoice>
@inject MovieTheater.Service.IAccountService AccountService
@{
    ViewData["Title"] = "Booking Management";

    var now = DateTime.Now;

    var totalBookings = Model.Count();

    var completed = Model.Count(b => b.Status == MovieTheater.Models.InvoiceStatus.Completed && !b.Cancel);

    var cancelled = Model.Count(b => b.Status == MovieTheater.Models.InvoiceStatus.Completed && b.Cancel);

    var notPaid = Model.Count(b => b.Status != MovieTheater.Models.InvoiceStatus.Completed);
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Booking Management</h2>
        <a href="@Url.Action("InitiateTicketSellingForMember", "Booking", new { id = "admin", returnUrl = Url.Action("MainPage", "Admin", new { tab = "BookingMg" }) })" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Sell Ticket
        </a>
    </div>

    <!-- Search and Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="bookingSearchForm" onsubmit="searchBookings(); return false;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchKeyword" name="keyword"
                               placeholder="Search by Booking ID, Account ID, Phone, Identity Card..." value="@ViewBag.Keyword">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="statusFilter" name="statusFilter">
                            @if (string.IsNullOrEmpty(ViewBag.StatusFilter?.ToString()))
                            {
                                <option value="" selected>All Status</option>
                            }
                            else
                            {
                                <option value="">All Status</option>
                            }
                            @if (ViewBag.StatusFilter?.ToString() == "completed")
                            {
                                <option value="completed" selected>Completed</option>
                            }
                            else
                            {
                                <option value="completed">Completed</option>
                            }
                            @if (ViewBag.StatusFilter?.ToString() == "cancelled")
                            {
                                <option value="cancelled" selected>Cancelled</option>
                            }
                            else
                            {
                                <option value="cancelled">Cancelled</option>
                            }
                            @if (ViewBag.StatusFilter?.ToString() == "notpaid")
                            {
                                <option value="notpaid" selected>Not Paid</option>
                            }
                            else
                            {
                                <option value="notpaid">Not Paid</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-outline-primary w-100">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                    <div class="col-md-2">
                        <a href="#" onclick="resetFilters(); return false;" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </a>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="bookingTypeFilter" id="allBookings" value="all" @(ViewBag.CurrentBookingTypeFilter == "all" || string.IsNullOrEmpty(ViewBag.CurrentBookingTypeFilter) ? "checked" : "")>
                            <label class="form-check-label" for="allBookings">All Bookings</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="bookingTypeFilter" id="normalBookings" value="normal" @(ViewBag.CurrentBookingTypeFilter == "normal" ? "checked" : "")>
                            <label class="form-check-label" for="normalBookings">Normal Bookings</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="bookingTypeFilter" id="employeeBookings" value="employee" @(ViewBag.CurrentBookingTypeFilter == "employee" ? "checked" : "")>
                            <label class="form-check-label" for="employeeBookings">Employee Bookings</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statisticsCards">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0" id="totalBookingsCount">@totalBookings</h4>
                            <p class="mb-0">Total Bookings</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-ticket-perforated fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0" id="completedCount">@completed</h4>
                            <p class="mb-0">Completed</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0" id="cancelledCount">@cancelled</h4>
                            <p class="mb-0">Cancelled</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-x-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0" id="notPaidCount">@notPaid</h4>
                            <p class="mb-0">Not Paid</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-hourglass-split fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking List -->
    <div class="card">
        <div class="card-body">
            <div id="bookingResult">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3">Loading bookings...</p>
                </div>
            </div>
            <nav id="bookingPagination" class="mt-3"></nav>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/admin-styles.css" />
    <link rel="stylesheet" href="~/css/pagination-styles.css" />
}
