@model IEnumerable<MovieTheater.Models.Invoice>
@inject MovieTheater.Service.IAccountService AccountService
@{
    ViewData["Title"] = "Booking Management";
    var now = DateTime.Now;
    var totalBookings = Model.Count();
    var completed = Model.Count(b => b.Status == MovieTheater.Models.InvoiceStatus.Completed && !b.Cancel);
    var cancelled = Model.Count(b => b.Status == MovieTheater.Models.InvoiceStatus.Completed && b.Cancel);
    var notPaid = Model.Count(b => b.Status != MovieTheater.Models.InvoiceStatus.Completed);
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Booking Management</h2>
        <a href="@Url.Action("InitiateTicketSellingForMember", "Booking", new { id = "admin", returnUrl = Url.Action("MainPage", "Admin", new { tab = "BookingMg" }) })" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Sell Ticket
        </a>
</div>

    <!-- Search and Filter Section -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="bookingSearchForm" class="row g-3" onsubmit="searchBookings(); return false;">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="searchKeyword" name="keyword"
                           placeholder="Search by Booking ID, Account ID, Phone, Identity Card..." value="@ViewBag.Keyword">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter" name="statusFilter">
                        <option value="" selected>All Status</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="notpaid">Not Paid</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <!-- Đã có sort bằng tiêu đề, không cần dropdown sortBy nữa -->
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-outline-primary w-100">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
                <div class="col-md-2">
                    <a href="#" onclick="loadTab('BookingMg'); return false;" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-arrow-clockwise"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@totalBookings</h4>
                            <p class="mb-0">Total Bookings</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-ticket-perforated fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@completed</h4>
                            <p class="mb-0">Completed</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@cancelled</h4>
                            <p class="mb-0">Cancelled</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-x-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@notPaid</h4>
                            <p class="mb-0">Not Paid</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-hourglass-split fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking List -->
    <div class="card">
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table id="booking-table" class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th class="text-center sortable" data-sort="id">Booking ID <span id="sortIconId"></span></th>
                                <th class="text-start sortable" data-sort="movie">Movie Name <span id="sortIconMovie"></span></th>
                                <th class="text-center sortable" data-sort="account">Account ID <span id="sortIconAccount"></span></th>
                                <th class="text-end sortable" data-sort="identity">Identity Card <span id="sortIconIdentity"></span></th>
                                <th class="text-end sortable" data-sort="phone">Phone Number <span id="sortIconPhone"></span></th>
                                <th class="text-end sortable" data-sort="time">Schedule Time <span id="sortIconTime"></span></th>
                                <th class="text-center">Status</th>
                                <th class="text-center">Actions</th>
        </tr>
    </thead>
    <tbody>
            @foreach (var Invoice in Model)
            {   
                var account = AccountService.GetById(Invoice.AccountId);
                                var statusBadge = Invoice.Status == MovieTheater.Models.InvoiceStatus.Completed && !Invoice.Cancel ?
                                    "<span class='badge bg-success'><i class='bi bi-check-circle me-1'></i>Completed</span>" :
                                    Invoice.Status == MovieTheater.Models.InvoiceStatus.Completed && Invoice.Cancel ?
                                    "<span class='badge bg-danger'><i class='bi bi-x-circle me-1'></i>Cancelled</span>" :
                                    "<span class='badge bg-secondary'><i class='bi bi-hourglass-split me-1'></i>Not Paid</span>";
                <tr class="text-center booking-row">
                                    <td class="text-center">@Invoice.InvoiceId</td>
                                    <td class="text-start">@(Invoice.MovieShow.Movie.MovieNameEnglish ?? "N/A")</td>
                                    <td class="text-center">@Invoice.AccountId</td>
                                    <td class="text-end">@(account?.IdentityCard ?? "N/A")</td>
                                    <td class="text-end">@(account?.PhoneNumber ?? "N/A")</td>
                                    <td class="text-end">@(Invoice.MovieShow.Schedule.ScheduleTime.ToString())</td>
                                    <td class="text-center">@Html.Raw(statusBadge)</td>
                                    <td class="text-center">
                        <a href="@Url.Action("TicketInfo", "Booking", new { invoiceId = Invoice.InvoiceId })" class="btn btn-sm btn-info">
                            <i class="fas fa-info-circle"></i> Details
                        </a>
                    </td>
                </tr>
        }
    </tbody>
</table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <i class="bi bi-emoji-frown display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">No bookings found</h4>
                    <p class="text-muted">Try adjusting your search criteria or add a new booking.</p>
                </div>
            }
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/admin-styles.css" />
}

@section Scripts {
    <script src="~/js/admin-sorting.js"></script>
}
