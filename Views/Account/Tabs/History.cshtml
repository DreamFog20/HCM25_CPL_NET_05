@{
    ViewData["Title"] = "Booking History";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="text-center mb-0">Booking History</h2>
                </div>
                <div class="card-body">
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div class="row align-items-end mb-4 flex-nowrap justify-content-between">
                        <div class="col-auto">
                            <form id="historyFilterForm" class="d-flex flex-row flex-nowrap align-items-end gap-2">
                                <div>
                                    <label class="filter-label mb-1">From Date</label>
                                    <input type="date" id="fromDate" name="fromDate" class="form-control filter-input" />
                                </div>
                                <div>
                                    <label class="filter-label mb-1">To Date</label>
                                    <input type="date" id="toDate" name="toDate" class="form-control filter-input" />
                                </div>
                                <div>
                                    <button type="submit" id="filterBtn" class="btn filter-btn filter-btn-primary mt-3 mt-md-0">
                                        <i class="fas fa-search"></i> Filter
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div class="col-auto">
                            <div class="btn-group status-btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary" id="btnAllTickets">
                                    <i class="fas fa-history"></i> All Tickets
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="btnBookedTickets">
                                    <i class="fas fa-ticket-alt"></i> Booked Tickets
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="btnCanceledTickets">
                                    <i class="fas fa-ban"></i> Canceled Tickets
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Booking History Table -->
                    <div id="historyResult">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading booking history...</p>
                        </div>
                    </div>
                    <nav id="historyPagination" class="mt-3"></nav>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script>
    $(function() {
        // Prevent form submission
        $('#historyFilterForm').attr('action', 'javascript:void(0)');
        $('#historyFilterForm').removeAttr('method');

        let historyDataCache = [];
        let currentPage = 1;
        const pageSize = 10;
        let currentStatus = 'all'; // all, booked, canceled

        // Navigation button events
        $('#btnAllTickets').on('click', function() {
            currentStatus = 'all';
            currentPage = 1;
            loadHistory($('#fromDate').val(), $('#toDate').val(), currentStatus);
            setActiveNavBtn('all');
        });
        $('#btnBookedTickets').on('click', function() {
            currentStatus = 'booked';
            currentPage = 1;
            loadHistory($('#fromDate').val(), $('#toDate').val(), currentStatus);
            setActiveNavBtn('booked');
        });
        $('#btnCanceledTickets').on('click', function() {
            currentStatus = 'canceled';
            currentPage = 1;
            loadHistory($('#fromDate').val(), $('#toDate').val(), currentStatus);
            setActiveNavBtn('canceled');
        });
        function setActiveNavBtn(status) {
            $('#btnAllTickets, #btnBookedTickets, #btnCanceledTickets').removeClass('active');
            if(status === 'all') $('#btnAllTickets').addClass('active');
            else if(status === 'booked') $('#btnBookedTickets').addClass('active');
            else if(status === 'canceled') $('#btnCanceledTickets').addClass('active');
        }
        setActiveNavBtn('all');

        function renderHistoryTable(historyData) {
            historyDataCache = historyData || [];
            renderHistoryPage(currentPage);
            renderHistoryPagination();
        }

        function renderHistoryPage(page) {
            let html = '';
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            const pageData = historyDataCache.slice(start, end);
            if (pageData.length > 0) {
                html += '<div class="table-responsive"><table class="table table-hover table-striped"><thead class="table-dark"><tr><th>Booking Date</th><th>Movie</th><th>Show Date</th><th>Show Time</th><th>Seats</th><th class="text-end">Total Amount</th><th>Status</th><th class="text-center">Actions</th></tr></thead><tbody>';
                pageData.forEach(function(booking) {
                    var bookingDate = booking.bookingDate ? new Date(booking.bookingDate).toLocaleString('vi-VN', {day: '2-digit',month: '2-digit',year: 'numeric',hour: '2-digit',minute: '2-digit'}) : 'N/A';
                    var showDate = booking.movieShow && booking.movieShow.showDate ? new Date(booking.movieShow.showDate).toLocaleDateString('vi-VN') : 'N/A';
                    var totalMoney = booking.totalMoney ? new Intl.NumberFormat('vi-VN').format(booking.totalMoney) + ' VND' : 'N/A';
                    var statusBadge = booking.status === 1 ? '<span class="badge bg-success">Booked</span>' : '<span class="badge bg-danger">Canceled</span>';
                    var cancelButton = '';
                    if (booking.status === 1 && booking.scheduleShow) {
                        var showDateTime = new Date(booking.scheduleShow);
                        var cancelDeadline = new Date(showDateTime.getTime() - 24 * 60 * 60 * 1000);
                        if (cancelDeadline > new Date()) {
                            cancelButton = '<form action="/Ticket/Cancel" method="post" class="d-inline" onsubmit="return confirm(\'Are you sure you want to cancel this ticket?\');">' +
                                '<input type="hidden" name="id" value="' + booking.invoiceId + '" />' +
                                '<button type="submit" class="btn btn-sm btn-danger">' +
                                '<i class="fas fa-times"></i> Cancel' +
                                '</button>' +
                                '</form>';
                        }
                    }
                    html += '<tr>' +
                        '<td>' + bookingDate + '</td>' +
                        '<td>' + (booking.movieShow && booking.movieShow.movie ? booking.movieShow.movie.movieNameEnglish : 'N/A') + '</td>' +
                        '<td>' + (booking.movieShow && booking.movieShow.showDate ? booking.movieShow.showDate : 'N/A') + '</td>' +
                        '<td>' + (
                            booking.movieShow && booking.movieShow.schedule && booking.movieShow.schedule.scheduleTime
                                ? booking.movieShow.schedule.scheduleTime.substring(0, 5)
                                : 'N/A'
                        ) + '</td>' +
                        '<td>' + (booking.seat || 'N/A') + '</td>' +
                        '<td class="text-end">' + totalMoney + '</td>' +
                        '<td>' + statusBadge + '</td>' +
                        '<td>' +
                        '<div class="btn-group">' +
                        '<a href="/Ticket/Details/' + booking.invoiceId + '" class="btn btn-sm btn-info">' +
                        '<i class="fas fa-info-circle"></i> Details' +
                        '</a>' +
                        cancelButton +
                        '</div>' +
                        '</td>' +
                        '</tr>';
                });
                html += '</tbody></table></div>';
            } else {
                html += '<div class="alert alert-info text-center"><i class="fas fa-info-circle me-2"></i>No booked tickets found.</div>';
            }
            $('#historyResult').html(html);
        }

        function renderHistoryPagination() {
            const totalPages = Math.ceil(historyDataCache.length / pageSize);
            if (totalPages <= 1) {
                $('#historyPagination').html('');
                return;
            }
            let html = '<ul class="pagination justify-content-center">';
            html += `<li class="page-item${currentPage === 1 ? ' disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item${currentPage === i ? ' active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }
            html += `<li class="page-item${currentPage === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage + 1}">Next</a></li>`;
            html += '</ul>';
            $('#historyPagination').html(html);
            $('#historyPagination .page-link').off('click').on('click', function (e) {
                e.preventDefault();
                const page = parseInt($(this).data('page'));
                if (!isNaN(page) && page >= 1 && page <= totalPages && page !== currentPage) {
                    currentPage = page;
                    renderHistoryPage(currentPage);
                    renderHistoryPagination();
                }
            });
        }

        function loadHistory(fromDate, toDate, status) {
            $('#filterBtn').prop('disabled', true);
            $('#filterBtn').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...');
            $.ajax({
                url: '/Ticket/HistoryPartial',
                type: 'GET',
                data: { fromDate: fromDate, toDate: toDate, status: status },
                success: function (response) {
                    if (response.success) {
                        currentPage = 1;
                        renderHistoryTable(response.data);
                    } else {
                        $('#historyResult').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ' + response.message + '</div>');
                    }
                    $('#accountTabs .nav-link').removeClass('active');
                    $('#accountTabs .nav-link[data-tab="History"]').addClass('active');
                },
                error: function () {
                    $('#historyResult').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error loading data.</div>');
                },
                complete: function() {
                    $('#filterBtn').prop('disabled', false);
                    $('#filterBtn').html('<i class="fas fa-search"></i> Filter');
                }
            });
        }

        // Handle form submit
        $('#historyFilterForm').on('submit', function(e) {
            e.preventDefault();
            var fromDate = $('#fromDate').val();
            var toDate = $('#toDate').val();
            loadHistory(fromDate, toDate, currentStatus);
        });

        // Load initial data (all records)
        loadHistory('', '', currentStatus);
    });
</script>

@section Styles {
    <style>
        .row.align-items-end.mb-4 {
            padding-left: 12px;
            padding-right: 12px;
        }
        #historyFilterForm {
            background: none;
            box-shadow: none;
            padding: 0;
            border-radius: 0;
        }
        #historyFilterForm .form-control {
            min-width: 160px;
            max-width: 180px;
        }
        .status-btn-group .btn {
            min-width: 150px;
            font-weight: 500;
            font-size: 1rem;
            padding: 0.5rem 1.2rem;
            border-radius: 8px !important;
            margin-left: 0.25rem;
            margin-right: 0.25rem;
            transition: background 0.2s, color 0.2s;
        }
        .status-btn-group .btn.active, .status-btn-group .btn:active, .status-btn-group .btn:focus {
            background: #1769fa !important;
            color: #fff !important;
            border-color: #1769fa !important;
        }
        .status-btn-group .btn-outline-primary {
            border-width: 2px;
        }
        .table th {
            white-space: nowrap;
        }
        .badge {
            font-size: 0.95em;
            padding: 0.5em 1.1em;
            border-radius: 1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .btn-group {
            gap: 0.5rem;
        }
        .table td {
            vertical-align: middle;
        }
        .btn-sm {
            padding: 0.25rem 0.7rem;
            font-size: 0.95rem;
            border-radius: 0.7rem;
        }
        .filter-label {
            color: rgb(65, 123, 199);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .filter-input {
            border: 1px solid rgb(65, 123, 199);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }
        .filter-input:focus {
            border-color: rgb(28, 109, 216);
            box-shadow: 0 0 0 3px rgba(65, 123, 199, 0.15);
        }
        .filter-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .filter-btn-primary {
            background: rgb(65, 123, 199);
            border-color: rgb(65, 123, 199);
        }
        .filter-btn-primary:hover {
            background: rgb(28, 109, 216);
            border-color: rgb(28, 109, 216);
            transform: translateY(-2px);
        }
        .filter-btn-success {
            background: rgb(56, 168, 134);
            border-color: rgb(56, 168, 134);
        }
        .filter-btn-success:hover {
            background: rgb(45, 147, 118);
            border-color: rgb(45, 147, 118);
            transform: translateY(-2px);
        }
        .table-responsive {
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            border-radius: 10px;
        }
        .btn-info {
            background: linear-gradient(90deg, #4f8cff 0%, #1769fa 100%);
            color: #fff;
            border: none;
        }
        .btn-info:hover {
            background: linear-gradient(90deg, #1769fa 0%, #4f8cff 100%);
            color: #fff;
        }
        @@media (max-width: 900px) {
            .row.align-items-end.mb-4 {
                flex-direction: column !important;
                align-items: stretch !important;
            }
            #historyFilterForm, .status-btn-group {
                justify-content: flex-start !important;
                margin-bottom: 10px;
            }
        }
    </style>
}
