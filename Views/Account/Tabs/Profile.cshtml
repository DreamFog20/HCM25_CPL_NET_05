@model MovieTheater.ViewModels.ProfilePageViewModel
@{
    ViewData["Title"] = "My Profile";
    var profile = Model.Profile;
    var rank = Model.RankInfo;
    var highestRank = Model.AllRanks?.OrderByDescending(r => r.RequiredPointsForCurrentRank).FirstOrDefault();
    bool isMaxRank = (highestRank != null && rank.CurrentRankId == highestRank.CurrentRankId);
    var currentRankDisplay = Model.AllRanks?.FirstOrDefault(r => r.CurrentRankId == rank.CurrentRankId);
    var bannerGradient = currentRankDisplay?.ColorGradient ?? rank.ColorGradient ?? "linear-gradient(135deg, #4e54c8 0%, #6c63ff 50%, #8f94fb 100%)";
    var defaultPoster = Url.Content("~/image/default-movie-poster.jpg");
}
<link rel="stylesheet" href="~/css/profile-page.css" asp-append-version="true" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<div class="profile-main-container">
    <div class="profile-2col-container">
        <div class="profile-2col-left">
            <div class="profile-modern-card">
                <div class="profile-banner-modern" style="background: @(currentRankDisplay?.ColorGradient ?? rank.ColorGradient ?? "linear-gradient(135deg, #4e54c8 0%, #6c63ff 50%, #8f94fb 100%)");">
                    <label for="profileImageInput" style="cursor: pointer;">
                        <img id="profileImagePreview" class="profile-avatar-modern" src="@(Model.Profile.Image ?? "/image/profile.jpg")" alt="Profile Image" />
                    </label>
                    <input type="file" id="profileImageInput" name="Profile.ImageFile" class="d-none" accept="image/*" />
                    <div style="font-size:1.4rem;font-weight:600;">
                        @Model.Profile.FullName
                        <span class="rank-badge" style="font-size:0.95rem;padding:0.18rem 0.9rem;margin:0">
                            <i class="@(currentRankDisplay?.IconClass ?? rank.IconClass ?? "fa-crown")" style="color: #333; font-size: 1.25rem; background: #fff; border-radius: 50%; padding: 0.25rem; border: 1px solid #e0e0e0; margin-right: 0.5rem;"></i> @rank.CurrentRankName
                        </span>
                        </div>
                  
                    <div class="profile-rank-info" style="color:white">
                        <span>Current Points  <b>@Model.RankInfo.CurrentScore</b></span>
                        <span>Total Points  <b>@Model.RankInfo.TotalPoints</b></span>
                    </div>
                    <div class="profile-progress-modern">
                        @if (!isMaxRank)
                        {
                            var profilePrevRankPoints = rank.RequiredPointsForCurrentRank;
                            var profileNextRankPoints = rank.RequiredPointsForNextRank;
                            var profilePointsForThisTier = profileNextRankPoints - profilePrevRankPoints;
                            var profileUserProgressInTier = rank.TotalPoints - profilePrevRankPoints;
                            var profileProgressPercentage = (profilePointsForThisTier > 0) ? Math.Max(0, Math.Min(100, (double)profileUserProgressInTier / profilePointsForThisTier * 100)) : (rank.TotalPoints >= profileNextRankPoints ? 100 : 0);
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: @(profileProgressPercentage.ToString("0.##"))%;">
                                    @profileProgressPercentage.ToString("0")%
                                </div>
                            </div>
                            <div style="margin-top:0.3rem;font-size:1.05rem;">
                                Next: <b>@rank.NextRankName</b> &mdash; <b>@(profileNextRankPoints - rank.TotalPoints)</b> points needed
                            </div>
                        }
                        else
                        {
                            <div class="progress">
                                <div class="progress-bar text-center" role="progressbar" style="width: 100%; align-content:center">Max</div>
                            </div>
                            <div style="margin-top:0.3rem;font-size:1.05rem;">
                                <i class="fas fa-crown"></i> Max Rank Achieved!
                            </div>
                        }
                    </div>
                </div>
                <form asp-controller="MyAccount" asp-action="Edit" method="post" enctype="multipart/form-data" id="profileForm" class="profile-form-modern mt-3">
                    <div class="form-group profile-form-row">
                        <label for="Profile_FullName" class="profile-label">Full Name</label>
                        <div class="profile-data">
                            <input asp-for="Profile.FullName" class="form-control" placeholder="Enter Full Name" />
                            <span asp-validation-for="Profile.FullName" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group profile-form-row">
                        <label for="Profile_DateOfBirth" class="profile-label">Date of Birth</label>
                        <div class="profile-data">
                            <input asp-for="Profile.DateOfBirth" type="date" class="form-control" />
                            <span asp-validation-for="Profile.DateOfBirth" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group profile-form-row">
                        <label class="profile-label">Gender</label>
                        <div class="profile-data d-flex align-items-center">
                            <div class="form-check form-check-inline gender-radio">
                                <input class="form-check-input" type="radio" asp-for="Profile.Gender" value="male" id="gender-male" />
                                <label class="form-check-label" for="gender-male">Male</label>
                            </div>
                            <div class="form-check form-check-inline gender-radio">
                                <input class="form-check-input" type="radio" asp-for="Profile.Gender" value="female" id="gender-female" />
                                <label class="form-check-label" for="gender-female">Female</label>
                            </div>
                            <div class="form-check form-check-inline gender-radio">
                                <input class="form-check-input" type="radio" asp-for="Profile.Gender" value="unknown" id="gender-unknown" />
                                <label class="form-check-label" for="gender-unknown">Other</label>
                            </div>
                            <span asp-validation-for="Profile.Gender" class="text-danger ms-2"></span>
                        </div>
                    </div>
                    <div class="form-group profile-form-row">
                        <label for="Profile_IdentityCard" class="profile-label">Identity Number</label>
                        <div class="profile-data">
                            <input asp-for="Profile.IdentityCard" class="form-control" placeholder="Enter Indentity Number" />
                            <span asp-validation-for="Profile.IdentityCard" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group profile-form-row">
                        <label for="Profile_Email" class="profile-label">Email</label>
                        <div class="profile-data">
                            <input asp-for="Profile.Email" class="form-control" readonly placeholder="Your Email" />
                            <span asp-validation-for="Profile.Email" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group profile-form-row">
                        <label for="Profile_Address" class="profile-label">Address</label>
                        <div class="profile-data">
                            <input asp-for="Profile.Address" class="form-control" placeholder="Enter address" />
                            <span asp-validation-for="Profile.Address" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group profile-form-row">
                        <label for="Profile_PhoneNumber" class="profile-label">Phone Number</label>
                        <div class="profile-data">
                            <input asp-for="Profile.PhoneNumber" class="form-control" placeholder="Enter Phone Number" />
                            <span asp-validation-for="Profile.PhoneNumber" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center gap-3 mt-4">
                        @if (!profile.IsGoogleAccount)
                        {
                            <a href="@Url.Action("ChangePassword", "MyAccount")" class="btn btn-secondary px-4 py-2 rounded">Change Password</a>
                        }
                        <button type="submit" name="action" value="editProfile" class="btn btn-primary px-4 py-2 rounded">Update</button>
                    </div>
                </form>
            </div>
            <partial name="_ToastMessages" />
        </div>
        <div class="profile-2col-right">
            <div class="mt-0 mb-4">
                <h3 class="mb-4" style="font-weight:700;color:#1769fa;"><i class="fas fa-history me-2"></i>Booking History</h3>
                <div id="profileHistoryCards">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading booking history...</p>
                    </div>
                </div>
                <nav id="profileHistoryPagination" class="mt-3"></nav>
            </div>
        </div>
    </div>
    </div>
<script>
    function initProfileAvatarUpload() {
        const imageInput = document.getElementById('profileImageInput');
        const imagePreview = document.getElementById('profileImagePreview');
        const avatarBtns = document.getElementById('avatarBtns');
        const cancelBtn = document.getElementById('cancelAvatarBtn');
        const originalSrc = imagePreview ? imagePreview.src : '';
        if (!imageInput || !imagePreview) return;
        imageInput.addEventListener('change', function(event) {
            if (event.target.files && event.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    if (avatarBtns) avatarBtns.classList.add('is-visible');
                }
                reader.readAsDataURL(event.target.files[0]);
            }
        });
        if (cancelBtn && avatarBtns) {
            cancelBtn.addEventListener('click', function() {
                imagePreview.src = originalSrc;
                imageInput.value = '';
                avatarBtns.classList.remove('is-visible');
            });
        }
    }
    initProfileAvatarUpload();
    // Booking History Cards AJAX
    $(function() {
        let historyDataCache = [];
        let currentPage = 1;
        const pageSize = 6;
        function renderHistoryCards(historyData) {
            historyDataCache = historyData || [];
            renderHistoryPage(currentPage);
            renderHistoryPagination();
        }
        function renderHistoryPage(page) {
            let html = '';
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            const pageData = historyDataCache.slice(start, end);
            if (pageData.length > 0) {
                html += '<div class="booking-card-list">';
                pageData.forEach(function(booking) {
                    var movieName = booking.movieShow && booking.movieShow.movie ? booking.movieShow.movie.movieNameEnglish : 'N/A';
                    var showDate = booking.movieShow && booking.movieShow.showDate ? new Date(booking.movieShow.showDate).toLocaleDateString('en-GB') : 'N/A';
                    var showTime = booking.movieShow && booking.movieShow.schedule && booking.movieShow.schedule.scheduleTime ? booking.movieShow.schedule.scheduleTime.substring(0, 5) : 'N/A';
                    var seats = booking.seat || '';
                    var seatCount = seats ? seats.split(',').length : 0;
                    var totalMoney = booking.totalMoney ? new Intl.NumberFormat('en-US').format(booking.totalMoney) + ' VND' : 'N/A';
                    var statusBadge = booking.status === 1 ? '<span class="badge bg-success">Booked</span>' : '<span class="badge bg-danger">Canceled</span>';
                    html += `<div class="booking-card">
                        <div class="booking-card-row booking-card-row-top">
                            <div class="booking-card-title">${movieName}</div>
                            <div class="booking-card-date" style="flex:1.5 1 0%;min-width:90px;max-width:160px;"><i class=\"fas fa-calendar-alt\"></i> ${showDate}</div>
                            <div class="booking-card-time"><i class=\"fas fa-clock\"></i> ${showTime}</div>
                            <div class="booking-card-actions dropdown">
                                <button class="btn btn-light btn-sm rounded-circle" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-ellipsis-v"></i></button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="/Ticket/Details/${booking.invoiceId}"><i class="fas fa-info-circle me-2"></i>Chi tiết</a></li>
                                    ${booking.status === 1 ? `<li><form action=\"/Ticket/Cancel\" method=\"post\" class=\"d-inline\" onsubmit=\"return confirm('Bạn có chắc muốn hủy vé này?');\"><input type=\"hidden\" name=\"id\" value=\"${booking.invoiceId}\" /><button type=\"submit\" class=\"dropdown-item\"><i class=\"fas fa-times me-2\"></i>Hủy vé</button></form></li>` : ''}
                                    <li><a class="dropdown-item" href="#" onclick="window.print();return false;"><i class="fas fa-print me-2"></i>In vé</a></li>
                                </ul>
                            </div>
                        </div>
                        <div class="booking-card-row booking-card-row-seats">
                            <div class="booking-card-seats"><i class=\"fas fa-chair\"></i> ${seatCount} seat(s): ${seats}</div>
                        </div>
                        <div class="booking-card-row booking-card-row-bottom">
                            <div class="booking-card-amount"><i class=\"fas fa-money-bill-wave\"></i> ${totalMoney}</div>
                            <div class="booking-card-status">${statusBadge}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            } else {
                html += '<div class="alert alert-info text-center"><i class="fas fa-info-circle me-2"></i>Không có vé nào.</div>';
            }
            $('#profileHistoryCards').html(html);
        }
        function renderHistoryPagination() {
            const totalPages = Math.ceil(historyDataCache.length / pageSize);
            if (totalPages <= 1) {
                $('#profileHistoryPagination').html('');
                return;
            }
            let html = '<ul class="pagination justify-content-center">';
            html += `<li class="page-item${currentPage === 1 ? ' disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a></li>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item${currentPage === i ? ' active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }
            html += `<li class="page-item${currentPage === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" data-page="${currentPage + 1}">Next</a></li>`;
            html += '</ul>';
            $('#profileHistoryPagination').html(html);
            $('#profileHistoryPagination .page-link').off('click').on('click', function (e) {
                e.preventDefault();
                const page = parseInt($(this).data('page'));
                if (!isNaN(page) && page >= 1 && page <= totalPages && page !== currentPage) {
                    currentPage = page;
                    renderHistoryPage(currentPage);
                    renderHistoryPagination();
                }
            });
        }
        function loadHistory() {
            $('#profileHistoryCards').html('<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-3">Loading booking history...</p></div>');
            $.ajax({
                url: '/Ticket/HistoryPartial',
                type: 'GET',
                data: {},
                success: function (response) {
                    if (response.success) {
                        currentPage = 1;
                        renderHistoryCards(response.data);
                    } else {
                        $('#profileHistoryCards').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ' + response.message + '</div>');
                    }
                },
                error: function () {
                    $('#profileHistoryCards').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Error loading data.</div>');
                }
            });
        }
        loadHistory();
    });
</script>
