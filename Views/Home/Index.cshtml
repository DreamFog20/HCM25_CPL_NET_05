@{
    ViewData["Title"] = "Home";
    var movies = ViewBag.Movies as IEnumerable<MovieTheater.Models.Movie>;
    var promotions = ViewBag.Promotions as IEnumerable<MovieTheater.Models.Promotion>;
}

<div class="container-xl py-4">
    <!-- Slideshow banner -->
    <div class="slideshow-container">
        <ul id="home_big_banner" class="slideshow"
            data-cycle-fx="fade"
            data-cycle-timeout="5000"
            data-cycle-slides="> li"
            data-cycle-pager=".home_big_banner_pager"
            data-cycle-pager-template="<span class='pager-bullet'></span>"
            data-cycle-prev=".home_big_banner_prev"
            data-cycle-next=".home_big_banner_next"
            data-cycle-swipe="true"
            data-cycle-swipe-fx="fade">
            <li class="slide-item">
                <a href="">
                    <img src="https://iguov8nhvyobj.vcdn.cloud/media/banner/cache/1/b58515f018eb873dafa430b6f9ae0c1e/9/8/980wx448h_1_-min_6.jpg" alt="Banner 1" />
                </a>
            </li>
            <li class="slide-item">
                <a href="">
                    <img src="https://iguov8nhvyobj.vcdn.cloud/media/banner/cache/1/b58515f018eb873dafa430b6f9ae0c1e/9/8/980wx448h-duoidayho.jpg" alt="Banner 2" />
                </a>
            </li>
            <li class="slide-item">
                <a href="">
                    <img src="https://i.ytimg.com/vi/8Yj61CP1Sic/maxresdefault.jpg" alt="Banner 3" />
                </a>
            </li>
            <li class="slide-item">
                <a href="">
                    <img src="https://www.bhdstar.vn/wp-content/uploads/2024/08/referenceSchemeHeadOfficeallowPlaceHoldertrueheight360ldapp.png" alt="Banner 4" />
                </a>
            </li>
        </ul>
        
        <!-- Navigation Buttons -->
        <button type="button" class="slideshow-prev home_big_banner_prev" aria-label="Previous slide" style="z-index: 1000; position: absolute; top: 50%; left: 20px; transform: translateY(-50%);">&#10094;</button>
        <button type="button" class="slideshow-next home_big_banner_next" aria-label="Next slide" style="z-index: 1000; position: absolute; top: 50%; right: 20px; transform: translateY(-50%);">&#10095;</button>
        
        <!-- Pagination -->
        <div class="home_big_banner_pager pager-container"></div>
    </div>

    <div class="mb-5"></div>

    <!-- Movie Slider -->
    <h2 class="section-title">MOVIE</h2>
    <div class="swiper movie-swiper mb-5">
        <div class="swiper-wrapper">
            @foreach (var movie in movies)
            {
                <div class="swiper-slide">
                    <div class="card movie-card h-100 shadow-sm">
                        <img src="@movie.SmallImage" class="card-img-top" alt="@movie.MovieNameEnglish">
                        <div class="card-body text-center">
                            <h5 class="card-title">@movie.MovieNameEnglish</h5>
                            <a asp-controller="Movie"
                               asp-action="Detail"
                               asp-route-id="@movie.MovieId"
                               class="btn btn-danger mt-2 px-4">
                                Book
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div class="swiper-pagination movie-pagination"></div>
        <div class="swiper-button-next movie-next"></div>
        <div class="swiper-button-prev movie-prev"></div>
    </div>

    <!-- Promotion Slider -->
    <h2 class="section-title">PROMOTION</h2>
    <div class="swiper promo-swiper mb-5">
        <div class="swiper-wrapper">
            @foreach (var promo in promotions)
            {
                <div class="swiper-slide">
                    <div class="card promo-card h-100 shadow-sm">
                        <img src="@promo.Image" class="card-img-top" alt="Promotion">
                        <div class="card-body text-center">
                            <p class="card-text">@promo.Detail</p>
                        </div>
                    </div>
                </div>
            }
        </div>
        <div class="swiper-pagination promo-pagination"></div>
        <div class="swiper-button-next promo-next"></div>
        <div class="swiper-button-prev promo-prev"></div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            console.log('Document ready');
            
            // Check if Cycle2 is loaded
            if (typeof $.fn.cycle === 'undefined') {
                console.error('Cycle2 plugin not loaded');
                // Fallback: manual slideshow
                initManualSlideshow();
                return;
            }

            console.log('Cycle2 plugin found');

            // Initialize cycle2 slideshow with explicit options
            try {
                var $slideshow = $('#home_big_banner');
                $slideshow.cycle({
                    fx: 'fade',
                    timeout: 5000,
                    slides: '> li',
                    pager: '.home_big_banner_pager',
                    pagerTemplate: '<span class="pager-bullet"></span>',
                    prev: '.home_big_banner_prev',
                    next: '.home_big_banner_next',
                    swipe: true,
                    swipeFx: 'fade',
                    log: true, // Enable logging for debugging
                    speed: 1000,
                    pauseOnHover: true,
                    allowWrap: true,
                    manualSpeed: 1000,
                    manualTrump: true
                });
                console.log('Cycle2 initialized successfully');
            } catch (error) {
                console.error('Error initializing Cycle2:', error);
                // Fallback: manual slideshow
                initManualSlideshow();
            }

            // Add click event handlers as backup
            $('.home_big_banner_prev').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Prev button clicked');
                try {
                    var $slideshow = $('#home_big_banner');
                    if ($slideshow.data('cycle.opts')) {
                        $slideshow.cycle('prev');
                        console.log('Cycle2 prev called');
                    } else {
                        manualPrev();
                    }
                } catch (error) {
                    console.error('Error navigating to previous slide:', error);
                    manualPrev();
                }
            });
            
            $('.home_big_banner_next').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Next button clicked');
                try {
                    var $slideshow = $('#home_big_banner');
                    if ($slideshow.data('cycle.opts')) {
                        $slideshow.cycle('next');
                        console.log('Cycle2 next called');
                    } else {
                        manualNext();
                    }
                } catch (error) {
                    console.error('Error navigating to next slide:', error);
                    manualNext();
                }
            });

            // Test if buttons are clickable
            $('.slideshow-prev, .slideshow-next').on('click', function(e) {
                console.log('Generic slideshow button clicked:', this.className);
            });
        });

        // Manual slideshow fallback
        var currentSlide = 0;
        var totalSlides = 0;
        var slideInterval;

        function initManualSlideshow() {
            console.log('Initializing manual slideshow');
            var $slides = $('#home_big_banner li');
            totalSlides = $slides.length;
            
            if (totalSlides === 0) {
                console.error('No slides found');
                return;
            }

            // Hide all slides except first
            $slides.hide();
            $slides.first().show();
            currentSlide = 0;

            // Create pagination
            createManualPagination();

            // Start auto-slide
            startAutoSlide();
        }

        function manualNext() {
            console.log('Manual next');
            var $slides = $('#home_big_banner li');
            $slides.eq(currentSlide).fadeOut(500);
            currentSlide = (currentSlide + 1) % totalSlides;
            $slides.eq(currentSlide).fadeIn(500);
            updatePagination();
        }

        function manualPrev() {
            console.log('Manual prev');
            var $slides = $('#home_big_banner li');
            $slides.eq(currentSlide).fadeOut(500);
            currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
            $slides.eq(currentSlide).fadeIn(500);
            updatePagination();
        }

        function createManualPagination() {
            var $pager = $('.home_big_banner_pager');
            $pager.empty();
            
            for (var i = 0; i < totalSlides; i++) {
                var $bullet = $('<span class="pager-bullet" data-slide="' + i + '"></span>');
                $bullet.on('click', function() {
                    var slideIndex = parseInt($(this).data('slide'));
                    goToSlide(slideIndex);
                });
                $pager.append($bullet);
            }
            updatePagination();
        }

        function goToSlide(index) {
            var $slides = $('#home_big_banner li');
            $slides.eq(currentSlide).fadeOut(500);
            currentSlide = index;
            $slides.eq(currentSlide).fadeIn(500);
            updatePagination();
        }

        function updatePagination() {
            $('.pager-bullet').removeClass('cycle-pager-active');
            $('.pager-bullet').eq(currentSlide).addClass('cycle-pager-active');
        }

        function startAutoSlide() {
            slideInterval = setInterval(function() {
                manualNext();
            }, 5000);
        }

        // Check if Swiper is loaded
        if (typeof Swiper === 'undefined') {
            console.error('Swiper library not loaded');
        } else {
            console.log('Swiper library found');
            // Initialize Swiper for movies
            try {
                var movieSwiper = new Swiper('.movie-swiper', {
                    effect: 'coverflow',
                    grabCursor: true,
                    centeredSlides: true,
                    slidesPerView: 4,
                    spaceBetween: 30,
                    coverflowEffect: {
                        rotate: 30,
                        stretch: 0,
                        depth: 200,
                        modifier: 1,
                        slideShadows: true,
                    },
                    navigation: {
                        nextEl: '.movie-next',
                        prevEl: '.movie-prev',
                    },
                    pagination: {
                        el: '.movie-pagination',
                        clickable: true,
                    },
                    breakpoints: {
                        0: { slidesPerView: 1 },
                        576: { slidesPerView: 2 },
                        992: { slidesPerView: 4 }
                    }
                });
                console.log('Movie Swiper initialized');
            } catch (error) {
                console.error('Error initializing movie Swiper:', error);
            }

            // Initialize Swiper for promotions
            try {
                var promoSwiper = new Swiper('.promo-swiper', {
                    slidesPerView: 4,
                    spaceBetween: 30,
                    navigation: {
                        nextEl: '.promo-next',
                        prevEl: '.promo-prev',
                    },
                    pagination: {
                        el: '.promo-pagination',
                        clickable: true,
                    },
                    breakpoints: {
                        0: { slidesPerView: 1 },
                        576: { slidesPerView: 2 },
                        992: { slidesPerView: 4 }
                    }
                });
                console.log('Promotion Swiper initialized');
            } catch (error) {
                console.error('Error initializing promotion Swiper:', error);
            }
        }
    </script>
}