@model MovieTheater.ViewModels.ShowtimeSelectionViewModel

<!--
    MT-20: Select Movie and Showtime View
    - Displays a date combobox (dropdown) for valid screening dates (AC-01)
    - Shows movies with posters and showtimes as buttons (AC-02)
    - If no showtimes, shows a 'No showtime' message (AC-04)
    - All data is read-only and based on the ViewModel (AC-05)
-->

@{
    ViewData["Title"] = "Ticket selling management â€“ Select movie and showtime";
    var isAuthenticated = User.Identity.IsAuthenticated;
}

@{
    var returnUrl = Context.Request.Query["ReturnUrl"].ToString();
    if (string.IsNullOrEmpty(returnUrl))
    {
        // Default to Booking Management if no ReturnUrl is provided
        returnUrl = Url.Action("MainPage", "Admin", new { tab = "BookingMg" });
    }
}
<div class="text-start p-3">
    <a href="@returnUrl" class="btn btn-secondary">&larr; Return</a>
</div>

<h2 class="text-center mb-4">SHOWTIMES</h2>

<div class="showtime-container p-4 rounded">
    <!-- Date navigation UI -->
    <form method="get" asp-action="Select" asp-controller="Showtime" class="mb-4 text-center" id="dateNavForm">
        <input type="hidden" name="returnUrl" value="@Model.ReturnUrl" />
        <input type="hidden" name="date" id="dateInput" value="@Model.SelectedDate.ToString("dd/MM/yyyy")" />
        <div class="d-inline-flex align-items-center gap-2">
            <button type="button" id="prevDayBtn" class="btn btn-outline-secondary btn-sm" title="Previous day">&lt;</button>
            <span id="selectedDate" class="fw-bold" style="cursor:pointer;">
                @Model.SelectedDate.ToString("dd/MM/yyyy")
            </span>
            <button type="button" id="nextDayBtn" class="btn btn-outline-secondary btn-sm" title="Next day">&gt;</button>
            <input type="date" id="calendarInput" style="display:none;" />
        </div>
    </form>

    @if (Model.Movies == null || !Model.Movies.Any())
    {
        <div class="alert alert-warning text-center">No showtime</div> <!-- AC-04 -->
    }
    else
    {
        foreach (var movie in Model.Movies)
        {
            <div class="card mb-4 mx-auto" style="max-width: 700px;">
                <div class="row g-0 align-items-center">
                    <div class="col-md-2 text-center">
                        <img src="@movie.PosterUrl" alt="@movie.MovieName" class="img-fluid rounded" style="max-height: 120px;" />
                    </div>
                    <div class="col-md-10">
                        <div class="card-body">
                            <h5 class="card-title mb-2">@movie.MovieName</h5>
                            <div class="mb-2 text-muted" style="font-size: 0.95em;">@movie.MovieName</div>
                            <div>
                                @foreach (var showtime in movie.Showtimes)
                                {
                                    <a asp-action="Select" asp-controller="Seat"
                                       asp-route-movieId="@movie.MovieId"
                                       asp-route-date="@Model.SelectedDate.ToString("dd/MM/yyyy")"
                                       asp-route-time="@showtime"
                                       asp-route-isAdminSell="true"
                                       asp-route-returnUrl="@Url.Action("Select", "Showtime", new { date = Model.SelectedDate.ToString("dd/MM/yyyy"), returnUrl = Model.ReturnUrl })"
                                       class="btn btn-outline-primary btn-sm m-1 bookBtn">
                                        @showtime
                                    </a>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<!--
    - Date combobox triggers form submit on change (AC-01)
    - Showtimes are links/buttons that redirect to seat selection with movieId, date, and time (AC-03)
    - If no showtimes, shows a warning message (AC-04)
    - All data is based on the ViewModel (active schedule, valid showtimes) (AC-05)
--> 

<script>
    // Helper to format Date object as dd/MM/yyyy
    function formatDate(date) {
        const d = date.getDate().toString().padStart(2, '0');
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    }

    // Parse dd/MM/yyyy to Date object
    function parseDate(str) {
        const [d, m, y] = str.split('/');
        return new Date(`${y}-${m}-${d}`);
    }

    // Get/set selected date
    function getSelectedDate() {
        return parseDate(document.getElementById('selectedDate').innerText.trim());
    }
    function setSelectedDate(date) {
        const formatted = formatDate(date);
        document.getElementById('selectedDate').innerText = formatted;
        document.getElementById('dateInput').value = formatted;
        document.getElementById('dateNavForm').submit();
    }

    document.getElementById('prevDayBtn').addEventListener('click', function() {
        const date = getSelectedDate();
        date.setDate(date.getDate() - 1);
        setSelectedDate(date);
    });

    document.getElementById('nextDayBtn').addEventListener('click', function() {
        const date = getSelectedDate();
        date.setDate(date.getDate() + 1);
        setSelectedDate(date);
    });

    document.getElementById('selectedDate').addEventListener('click', function() {
        const calendar = document.getElementById('calendarInput');
        // Set calendar value to current date in yyyy-MM-dd
        const date = getSelectedDate();
        calendar.value = date.toISOString().slice(0, 10);
        calendar.style.display = 'inline-block';
        calendar.focus();
    });

    document.getElementById('calendarInput').addEventListener('change', function() {
        const date = new Date(this.value);
        setSelectedDate(date);
        this.style.display = 'none';
    });

    // Hide calendar if it loses focus
    document.getElementById('calendarInput').addEventListener('blur', function() {
        setTimeout(() => { this.style.display = 'none'; }, 200);
    });
</script>