@model MovieTheater.ViewModels.ConfirmBookingViewModel
@{
    decimal seatPrice = Model.SelectedSeats != null
        ? Model.SelectedSeats.Sum(s => (decimal?)(s.PriceAfterPromotion ?? s.Price) ?? 0)
        : 0;
    ViewBag.CurrentStep = 3;
}

@Html.Partial("_BookingProgress")

<div class="min-vh-100 bg-gradient-to-br from-slate-50 to-blue-50 py-4">
    <div class="1">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex align-items-center justify-content-between bg-white p-4" style="border-radius: 1.5rem;">
                    <div style="padding-left: 950px;">
                        <h1 class="h3 fw-bold text-dark mb-1">🎬 Confirm Your Booking</h1>
                        <p class="text-muted mb-0">Review your selection and complete your purchase</p>
                    </div>
                    <a href="@Url.Action("Select", "Seat", new { movieId = Model.MovieId, date = Model.ShowDate.ToString("dd/MM/yyyy"), time = Model.ShowTime, versionId = Model.VersionId })" 
                       class="btn btn-outline-secondary rounded-pill px-4">
                        <i class="fas fa-arrow-left me-2"></i>Back to Seats
                    </a>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Cột 1: Selected Seats -->
            <div class="col-lg-3">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-gradient-info text-white rounded-top-4 py-3">
                        <h5 class="mb-0 fw-semibold">🪑 Selected Seats</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0 py-3 ps-4">Seat</th>
                                        <th class="border-0 py-3">Type</th>
                                        <th class="border-0 py-3 pe-4">Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var seat in Model.SelectedSeats)
                                    {
                                        <tr>
                                            <td class="py-3 ps-4">
                                                <span class="badge bg-primary fs-6">@seat.SeatName</span>
                                            </td>
                                            <td class="py-3">
                                                <span class="text-muted">@seat.SeatType</span>
                                            </td>
                                            <td class="py-3 pe-4">
                                                @if (seat.OriginalPrice.HasValue && seat.PromotionDiscount.HasValue && seat.PromotionDiscount.Value > 0)
                                                {
                                                    <div class="price-container">
                                                        <span class="original-price">@seat.OriginalPrice.Value.ToString("N0") VND</span>
                                                        <span class="discounted-price">@seat.PriceAfterPromotion.Value.ToString("N0") VND</span>
                                                        @if (!string.IsNullOrEmpty(seat.PromotionName))
                                                        {
                                                            <span class="badge bg-success ms-2">@seat.PromotionName</span>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="fw-semibold text-success">@seat.Price.ToString("N0") VND</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="3" class="py-3 ps-4 fw-semibold">Seats Total:</td>
                                        <td class="py-3 pe-4 fw-bold text-success">@Model.Subtotal.ToString("N0") VND</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cột 2: Food & Beverages -->
            <div class="col-lg-3">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-gradient-warning text-dark rounded-top-4 py-3">
                        <h5 class="mb-0 fw-semibold">🍿 Food & Drinks</h5>
                    </div>
                    <div class="card-body p-0">
                        @if (Model.SelectedFoods != null && Model.SelectedFoods.Count > 0)
                        {
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="border-0 py-3 ps-4">Item</th>
                                            <th class="border-0 py-3">Quantity</th>
                                            <th class="border-0 py-3">Unit Price</th>
                                            <th class="border-0 py-3 pe-4">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var food in Model.SelectedFoods)
                                        {
                                            <tr>
                                                <td class="py-3 ps-4">
                                                    <div class="d-flex align-items-center">
                                                        <img src="@food.Image" alt="@food.Name" 
                                                             class="rounded-3 me-3 food-image" />
                                                        <div>
                                                            <div class="fw-semibold">@food.Name</div>
                                                            @if (!string.IsNullOrEmpty(food.PromotionName))
                                                            {
                                                                <span class="badge bg-success small">@food.PromotionName (@food.PromotionDiscount.ToString("N0")% off)</span>
                                                            }
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="py-3">
                                                    <span class="badge bg-secondary">@food.Quantity</span>
                                                </td>
                                                <td class="py-3">
                                                    @if (food.PromotionDiscount > 0 && food.OriginalPrice > food.Price)
                                                    {
                                                        <div class="price-container">
                                                            <span class="original-price small">@food.OriginalPrice.ToString("N0") VND</span>
                                                            <span class="discounted-price">@food.Price.ToString("N0") VND</span>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span class="fw-semibold text-success">@food.Price.ToString("N0") VND</span>
                                                    }
                                                </td>
                                                <td class="py-3 pe-4">
                                                    <span class="fw-bold">@((food.Price * food.Quantity).ToString("N0")) VND</span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="3" class="py-3 ps-4 fw-semibold">Food & Drinks Total:</td>
                                            <td class="py-3 pe-4 fw-bold text-success">@Model.TotalFoodPrice.ToString("N0") VND</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                                <p class="text-muted mb-0">No foods selected</p>
                                <small class="text-muted">You can add food & beverages during your booking</small>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Cột 3: Movie & Show Details + Your Information -->
            <div class="col-lg-3">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-gradient-primary text-white rounded-top-4 py-3">
                        <h5 class="mb-0 fw-semibold">🎭 Movie & Show Details</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <span class="info-label">Movie</span>
                                    <span class="info-value">@Model.MovieName</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <span class="info-label">Screen</span>
                                    <span class="info-value">@Model.CinemaRoomName</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <span class="info-label">Version</span>
                                    <span class="info-value">@Model.VersionName</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <span class="info-label">Date & Time</span>
                                    <span class="info-value">@Model.ShowDate.ToString("MMM dd, yyyy") at @Model.ShowTime</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-gradient-success text-white rounded-top-4 py-3">
                        <h5 class="mb-0 fw-semibold">👤 Your Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="info-item">
                                    <span class="info-label">Full Name</span>
                                    <span class="info-value">@Model.FullName</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-item">
                                    <span class="info-label">Email</span>
                                    <span class="info-value">@Model.Email</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-item">
                                    <span class="info-label">Identity Card</span>
                                    <span class="info-value">@Model.IdentityCard</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-item">
                                    <span class="info-label">Phone</span>
                                    <span class="info-value">@Model.PhoneNumber</span>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-item">
                                    <span class="info-label">Available Points</span>
                                    <span class="info-value">
                                        <span id="currentScore" class="badge bg-warning text-dark fs-6">@Model.CurrentScore pts</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cột 4: Discount, Price, Confirm (giữ nguyên) -->
            <div class="col-lg-3">
                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-header bg-gradient-dark text-white rounded-top-4 py-3">
                        <h5 class="mb-0 fw-semibold">💰 Discounts & Points</h5>
                    </div>
                    <div class="card-body p-4">
                        <!-- Points Usage -->
                        <div class="mb-4">
                            <label for="useScore" class="form-label fw-semibold">
                                <i class="fas fa-star text-warning me-2"></i>Use Points
                            </label>
                            <div class="input-group">
                                <input asp-for="UseScore" type="number" class="form-control form-control-lg" 
                                       id="useScore" min="0" value="0" placeholder="0" />
                                <span class="input-group-text">pts</span>
                            </div>
                            <div class="form-text">
                                <small class="text-muted">
                                    1 point = 1,000 VND | Max: <span id="maxUsablePoints" class="fw-semibold">(calculating...)</span>
                                </small>
                            </div>
                            <div id="pointsEarnedPreview" class="text-success small mt-1"></div>
                            <div id="pointValidation" class="text-danger small mt-1"></div>
                            <div id="pointSavings" class="text-success small mt-1"></div>
                        </div>
                        <!-- Voucher Selection -->
                        <div class="mb-3">
                            <button type="button" id="openVoucherModalBtn" 
                                    class="btn btn-outline-primary btn-lg w-100 rounded-pill">
                                <i class="fas fa-ticket-alt me-2"></i>Select Voucher
                            </button>
                            <div id="selectedVoucherInfo" class="mt-3"></div>
                        </div>
                    </div>
                </div>
                <div class="card border-0 shadow-lg rounded-4 mb-4 price-summary-card">
                    <div class="card-header bg-gradient-primary text-white rounded-top-4 py-3">
                        <h5 class="mb-0 fw-semibold">📊 Price Summary</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="price-breakdown">
                            <div class="price-row">
                                <span>Seat Price:</span>
                                <span id="originalTotal">@seatPrice.ToString("N0") VND</span>
                            </div>
                            @if (Model.TotalFoodPrice > 0)
                            {
                                <div class="price-row">
                                    <span>Food & Beverages:</span>
                                    <span id="foodTotal">@Model.TotalFoodPrice.ToString("N0") VND</span>
                                </div>
                            }
                            <div id="rankDiscountRow" class="price-row discount-row" style="display:none;">
                                <span>Rank Discount:</span>
                                <span id="rankDiscountDisplay" class="text-success"></span>
                            </div>
                            <div id="voucherDiscountRow" class="price-row discount-row" style="display:none;">
                                <span>Voucher Discount:</span>
                                <span id="voucherDiscountDisplay" class="text-success"></span>
                            </div>
                            <div id="promotionDiscountRow" class="price-row discount-row" style="display:none;">
                                <span>Promotion Discount:</span>
                                <span id="promotionDiscountDisplay" class="text-success"></span>
                            </div>
                            <div id="pointsUsedRow" class="price-row discount-row" style="display:none;">
                                <span>Points Used:</span>
                                <span id="pointsUsedDisplay" class="text-success"></span>
                            </div>
                            <hr class="my-3">
                            <div class="price-row total-row">
                                <span class="fw-bold fs-5">Total Price:</span>
                                <span id="totalPriceDisplay" class="fw-bold fs-4 text-primary">@Model.TotalPrice.ToString("N0") VND</span>
                            </div>
                            <div class="d-grid gap-2 mb-4">
                                <form asp-action="Confirm" method="post" id="confirmForm">
                                    @Html.HiddenFor(m => m.MovieId)
                                    @Html.HiddenFor(m => m.MovieName)
                                    @Html.HiddenFor(m => m.CinemaRoomName)
                                    @Html.HiddenFor(m => m.ShowDate)
                                    @Html.HiddenFor(m => m.ShowTime)
                                    @Html.HiddenFor(m => m.TotalPrice)
                                    @Html.HiddenFor(m => m.FullName)
                                    @Html.HiddenFor(m => m.Email)
                                    @Html.HiddenFor(m => m.IdentityCard)
                                    @Html.HiddenFor(m => m.PhoneNumber)
                                    @Html.HiddenFor(m => m.CurrentScore)
                                    @Html.HiddenFor(m => m.MovieShowId)
                                    @Html.HiddenFor(m => m.Subtotal)
                                    @Html.HiddenFor(m => m.RankDiscount)
                                    @Html.HiddenFor(m => m.RankDiscountPercent)
                                    @Html.HiddenFor(m => m.PromotionDiscountPercent)
                                    @Html.HiddenFor(m => m.AddScore)
                                    @Html.HiddenFor(m => m.TotalFoodPrice)
                                    @Html.HiddenFor(m => m.EarningRate)
                                    <input type="hidden" name="UseScore" id="hiddenUseScore" value="0" />
                                    <input type="hidden" name="IsTestSuccess" id="isTestSuccess" value="false" />
                                    <input type="hidden" name="SelectedVoucherId" id="hiddenVoucherId" />
                                    <input type="hidden" name="VoucherAmount" id="hiddenVoucherAmount" value="@Model.VoucherAmount" />
                                    <input type="hidden" name="SelectedPromotionId" id="hiddenPromotionId" />
                                    @for (int i = 0; i < Model.SelectedSeats.Count; i++)
                                    {
                                        <input type="hidden" name="SelectedSeats[@i].SeatName" value="@Model.SelectedSeats[i].SeatName" />
                                        <input type="hidden" name="SelectedSeats[@i].SeatType" value="@Model.SelectedSeats[i].SeatType" />
                                        <input type="hidden" name="SelectedSeats[@i].Price" value="@Model.SelectedSeats[i].Price" />
                                        <input type="hidden" name="SelectedSeats[@i].SeatId" value="@Model.SelectedSeats[i].SeatId" />
                                    }
                                    @for (int i = 0; i < Model.SelectedFoods.Count; i++)
                                    {
                                        <input type="hidden" name="SelectedFoods[@i].FoodId" value="@Model.SelectedFoods[i].FoodId" />
                                        <input type="hidden" name="SelectedFoods[@i].Name" value="@Model.SelectedFoods[i].Name" />
                                        <input type="hidden" name="SelectedFoods[@i].Price" value="@Model.SelectedFoods[i].Price" />
                                        <input type="hidden" name="SelectedFoods[@i].Quantity" value="@Model.SelectedFoods[i].Quantity" />
                                        <input type="hidden" name="SelectedFoods[@i].Image" value="@Model.SelectedFoods[i].Image" />
                                        <input type="hidden" name="SelectedFoods[@i].Description" value="@Model.SelectedFoods[i].Description" />
                                        <input type="hidden" name="SelectedFoods[@i].Category" value="@Model.SelectedFoods[i].Category" />
                                        <input type="hidden" name="SelectedFoods[@i].Status" value="@Model.SelectedFoods[i].Status" />
                                        <input type="hidden" name="SelectedFoods[@i].CreatedDate" value="@Model.SelectedFoods[i].CreatedDate" />
                                        <input type="hidden" name="SelectedFoods[@i].UpdatedDate" value="@Model.SelectedFoods[i].UpdatedDate" />
                                        <input type="hidden" name="SelectedFoods[@i].PromotionDiscount" value="@Model.SelectedFoods[i].PromotionDiscount" />
                                    }
                                    <button id="confirmBtn" type="submit" class="btn btn-success btn-lg rounded-pill py-3 fw-semibold">
                                        <i class="fas fa-check-circle me-2"></i>Confirm Booking
                                    </button>
                                    <button type="button" class="btn btn-outline-success rounded-pill" onclick="testSuccess()">
                                        <i class="fas fa-flask me-2"></i>Test Success
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>

<!-- Voucher Selection Modal -->
<div class="modal fade" id="voucherModal" tabindex="-1" aria-labelledby="voucherModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow-lg">
            <div class="modal-header bg-gradient-primary text-white rounded-top-4 py-3">
                <h5 class="modal-title fw-semibold" id="voucherModalLabel">
                    <i class="fas fa-ticket-alt me-2"></i>My Vouchers
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3" id="voucherListContainer">
                    <!-- Voucher cards will load here -->
                </div>
                <div class="text-center mt-4">
                    <button type="button" class="btn btn-outline-secondary rounded-pill px-4" id="clearVoucherBtn">
                        <i class="fas fa-times me-2"></i>Clear Selection
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/booking-confirm-styles.css" />
}

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script>
    $(document).ready(function () {
        // Use the correct seat price from Razor
        var originalTotal = @seatPrice.ToString(System.Globalization.CultureInfo.InvariantCulture);
        var foodPrices = @Model.TotalFoodPrice.ToString(System.Globalization.CultureInfo.InvariantCulture);
        var discountPercent = @Model.RankDiscountPercent.ToString(System.Globalization.CultureInfo.InvariantCulture);
        var earningRate = @Model.EarningRate.ToString(System.Globalization.CultureInfo.InvariantCulture);
        var currentScore = @Model.CurrentScore.ToString(System.Globalization.CultureInfo.InvariantCulture);
        var pointValue = 1000;
        let voucherModalInstance = null;
        let selectedVoucher = null;
        let selectedPromotion = null;

        $('#openVoucherModalBtn').click(function () {
            if (!voucherModalInstance) {
                voucherModalInstance = new bootstrap.Modal(document.getElementById('voucherModal'));
            }
            loadVouchers();
            voucherModalInstance.show();
        });

        $('#clearVoucherBtn').click(function () {
            selectedVoucher = null;
            $('#selectedVoucherInfo').html('');
            $('.voucher-card').removeClass('selected');
            updatePriceFlow();
            if (voucherModalInstance) voucherModalInstance.hide();
        });

        // Load vouchers via API
        function loadVouchers() {
            $('#voucherListContainer').html('<div class="col-12 text-center"><div class="loading-spinner"></div><p class="mt-2">Loading vouchers...</p></div>');
            
            $.ajax({
                url: '/Voucher/GetAvailableVouchers',
                method: 'GET',
                success: function (data) {
                    let html = '';
                    if (data.length === 0) {
                        html = '<div class="col-12 text-center"><div class="py-4"><i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i><p class="text-muted">No available vouchers found.</p></div></div>';
                    } else {
                        data.forEach(v => {
                            html += `
                            <div class="col-md-6 mb-3">
                              <div class="card voucher-card h-100" data-id="${v.id}" data-value="${v.value}">
                                <div class="card-body text-center p-3">
                                  <div class="voucher-icon mb-2">
                                    <i class="fas fa-ticket-alt fa-2x text-primary"></i>
                                  </div>
                                  <h6 class="card-title fw-bold text-primary mb-2">${v.code}</h6>
                                  <p class="card-text mb-1">
                                    <span class="badge bg-success fs-6">${v.value.toLocaleString()} VND</span>
                                  </p>
                                  <p class="card-text small text-muted">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    Expires: ${v.expirationDate}
                                  </p>
                                </div>
                              </div>
                            </div>`;
                        });
                    }
                    $('#voucherListContainer').html(html);
                    
                    $('.voucher-card').click(function () {
                        $('.voucher-card').removeClass('selected');
                        $(this).addClass('selected');
                        selectedVoucher = {
                            id: $(this).data('id'),
                            value: $(this).data('value')
                        };
                        renderSelectedVoucherInfo();
                        updatePriceFlow();
                        if (voucherModalInstance) voucherModalInstance.hide();
                    });
                },
                error: function() {
                    $('#voucherListContainer').html('<div class="col-12 text-center"><div class="py-4"><i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i><p class="text-danger">Error loading vouchers. Please try again.</p></div></div>');
                }
            });
        }

        function renderSelectedVoucherInfo() {
            if (selectedVoucher) {
                $('#selectedVoucherInfo').html(`
                    <div class="selected-voucher-display">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-ticket-alt text-success me-2"></i>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">Selected Voucher</div>
                                <div class="small text-muted">${selectedVoucher.id}</div>
                                <div class="fw-bold text-success">${selectedVoucher.value.toLocaleString()} VND</div>
                            </div>
                        </div>
                        <button type="button" class="remove-voucher-btn" title="Remove voucher">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `);
                
                $('.remove-voucher-btn').off('click').on('click', function () {
                    selectedVoucher = null;
                    $('#selectedVoucherInfo').html('');
                    $('.voucher-card').removeClass('selected');
                    updatePriceFlow();
                });
            } else {
                $('#selectedVoucherInfo').html('');
            }
        }

        function updateMaxUsablePoints(discountedTotal) {
            var maxPoints = Math.floor((discountedTotal * 0.9) / pointValue);
            maxPoints = Math.min(maxPoints, currentScore);
            $('#maxUsablePoints').text(maxPoints + ' pts');
            $('#useScore').attr('max', maxPoints);
            return maxPoints;
        }

        function updatePriceFlow() {
            var originalTotal = @seatPrice.ToString(System.Globalization.CultureInfo.InvariantCulture);
            var subtotal = @Model.Subtotal.ToString(System.Globalization.CultureInfo.InvariantCulture);
            var foodPrices = @Model.TotalFoodPrice.ToString(System.Globalization.CultureInfo.InvariantCulture);

            // Rank discount is applied to subtotal (after promotion)
            var rankDiscountPercent = @Model.RankDiscountPercent.ToString(System.Globalization.CultureInfo.InvariantCulture);
            var rankDiscountAmount = Math.round(subtotal * (rankDiscountPercent / 100));
            var afterRank = subtotal - rankDiscountAmount;
            if (afterRank < 0) afterRank = 0;

            var promotionPercent = selectedPromotion ? selectedPromotion.discountPercent : 0;
            var promoDiscountAmount = Math.round(afterRank * (promotionPercent / 100));
            var afterPromo = afterRank - promoDiscountAmount;
            if (afterPromo < 0) afterPromo = 0;

            // Voucher chỉ áp dụng cho seat
            var voucherAmount = selectedVoucher ? selectedVoucher.value : 0;
            var afterVoucher = afterPromo - voucherAmount;
            if (afterVoucher < 0) afterVoucher = 0;

            // Points chỉ áp dụng cho seat
            var useScore = parseInt($('#useScore').val()) || 0;
            var maxUsablePoints = updateMaxUsablePoints(afterVoucher);
            var valid = true;
            var validationMsg = '';
            var pointsValue = useScore * pointValue;

            if (useScore > maxUsablePoints) {   
                useScore = maxUsablePoints;
                $('#useScore').val(useScore);
            }

            if (useScore < 0) useScore = 0;

            if (useScore > 0 && pointsValue > afterVoucher) {
                useScore = Math.floor(afterVoucher / pointValue);
                $('#useScore').val(useScore);
            }

            pointsValue = useScore * pointValue;
            var seatFinal = afterVoucher - pointsValue;
            if (seatFinal < 0) seatFinal = 0;

            // Tổng cuối cùng = seatFinal + food
            var finalTotal = seatFinal + parseInt(foodPrices);

            // Update UI
            $('#originalTotal').text(Number(originalTotal).toLocaleString() + ' VND');
            $('#totalPriceDisplay').html(`<strong>${finalTotal.toLocaleString()} VND</strong>`);

            // Cập nhật input ẩn tổng tiền để gửi sang payment
            $("#TotalPrice").val(finalTotal);

            // Rank discount row
            if (rankDiscountPercent > 0) {
                $('#rankDiscountRow').show();
                $('#rankDiscountDisplay').text(`-${rankDiscountAmount.toLocaleString()} VND (${rankDiscountPercent}%)`);
            } else {
                $('#rankDiscountRow').hide();
            }

            // Voucher discount row
            if (voucherAmount > 0) {
                $('#voucherDiscountRow').show();
                $('#voucherDiscountDisplay').text(`-${voucherAmount.toLocaleString()} VND`);
            } else {
                $('#voucherDiscountRow').hide();
            }

            // Promotion discount row (placeholder)
            if (promotionPercent > 0) {
                $('#promotionDiscountRow').show();
                $('#promotionDiscountDisplay').text(`-${promoDiscountAmount.toLocaleString()} VND (${promotionPercent}%)`);
            } else {
                $('#promotionDiscountRow').hide();
            }

            // Points used row
            const pointsUsedRow = document.getElementById('pointsUsedRow');
            const pointsUsedDisplay = document.getElementById('pointsUsedDisplay');
            if (useScore > 0 && valid) {
                pointsUsedDisplay.textContent = `-${(useScore * pointValue).toLocaleString()} VND`;
                pointsUsedRow.style.display = '';
            } else {
                pointsUsedRow.style.display = 'none';
            }

            // Point earning preview
            var pointsToEarn = 0;
            if (valid) {
                pointsToEarn = Math.round(seatFinal * earningRate / 100 / pointValue);
            }
            $('#pointsEarnedPreview').html(`<i class="fas fa-star text-warning me-1"></i>You will earn <strong>${pointsToEarn}</strong> point${pointsToEarn === 1 ? '' : 's'} from this transaction`).addClass('text-success').show();

            // Savings
            if (valid && useScore > 0) {
                var savings = useScore * pointValue;
                $('#pointSavings').html(`<i class="fas fa-piggy-bank text-success me-1"></i>Using <strong>${useScore}</strong> points saves you <strong>${savings.toLocaleString()} VND</strong>`);
            } else {
                $('#pointSavings').text('');
            }

            // Validation
            $('#pointValidation').text(validationMsg);
            $('#confirmBtn').prop('disabled', !valid);
            $('#hiddenUseScore').val(valid ? useScore : 0);
            $('#hiddenVoucherId').val(selectedVoucher ? selectedVoucher.id : '');
            $('#hiddenVoucherAmount').val(selectedVoucher ? selectedVoucher.value : 0);
            $('#hiddenPromotionId').val(selectedPromotion ? selectedPromotion.id : '');
        }

        $('#useScore').on('input', function () {
            var max = parseInt($(this).attr('max')) || 0;
            var val = parseInt($(this).val()) || 0;
            if (val > max) {
                $(this).val(max);
            }
            updatePriceFlow();
        });

        // Initial state
        updatePriceFlow();

        // Add this to log voucher amount before form submission
        $('#confirmBtn').on('click', function(e) {
            // Show loading state
            $(this).html('<i class="fas fa-spinner fa-spin me-2"></i>Processing...').prop('disabled', true);
            
            // Ensure price flow is updated before submit
            updatePriceFlow();
            console.log('VoucherAmount before submit:', $('#hiddenVoucherAmount').val());
        });
    });

    function testSuccess() {
        var useScoreInput = document.getElementById('useScore');
        var hiddenUseScore = document.getElementById('hiddenUseScore');
        var isTestSuccess = document.getElementById('isTestSuccess');

        if (useScoreInput && hiddenUseScore) {
            hiddenUseScore.value = useScoreInput.value || 0;
        }

        if (isTestSuccess) {
            isTestSuccess.value = "true";
        }

        document.querySelector('form[method="post"]').submit();
    }
</script>
