@{
    ViewData["Title"] = "Choose Show";
    var movieList = ViewBag.MovieList as List<MovieTheater.Models.Movie>;
    var selectedMovieId = ViewBag.SelectedMovieId as string;
    var showsByDate = ViewBag.ShowsByDate as Dictionary<string, List<string>>;
}

<div class="container mt-5 d-flex justify-content-center">
    <div class="card shadow p-4 w-50 w-md-50">
        <h2 class="text-center mb-4" style="font-size: x-large">🎬 Book Your Ticket</h2>

        <form id="bookingForm" novalidate>
            <div class="mb-4">
                <label for="movieSelect" class="form-label"><strong>Movie</strong></label>
                <select id="movieSelect" class="form-select" onchange="window.location.href='/Booking/TicketBooking?movieId=' + this.value">
                    <option value="">— Select Movie —</option>
                    @foreach (var m in movieList)
                    {
                        if (m.MovieId == selectedMovieId)
                        {
                            <option value="@m.MovieId" selected>@m.MovieNameEnglish</option>
                        }
                        else
                        {
                            <option value="@m.MovieId">@m.MovieNameEnglish</option>
                        }
                    }
                </select>
            </div>

            @if (!string.IsNullOrEmpty(selectedMovieId) && showsByDate != null)
            {
                <div class="mb-4">
                    <label for="dateSelect" class="form-label"><strong>Date</strong></label>
                    <select id="dateSelect" class="form-select" onchange="updateTimes(this.value)">
                        <option value="">— Select Date —</option>
                        @foreach (var date in showsByDate.Keys.OrderBy(d => DateTime.ParseExact(d, "dd/MM/yyyy", null)))
                        {
                            <option value="@date">@date</option>
                        }
                    </select>
                </div>

                <div class="mb-4">
                    <label for="timeSelect" class="form-label"><strong>Time</strong></label>
                    <select id="timeSelect" class="form-select">
                        <option value="">— Select Time —</option>
                    </select>
                </div>

                <button type="button" id="bookBtn" class="btn btn-success w-100" onclick="continueToSeats()">
                    Continue to Seat Selection
                </button>
            }
        </form>
    </div>
</div>

@section Scripts {
    <script>
        const showsByDate = @Html.Raw(Json.Serialize(showsByDate));

        function updateTimes(date) {
            const timeSelect = document.getElementById('timeSelect');
            timeSelect.innerHTML = '<option value="">— Select Time —</option>';
            
            if (date && showsByDate[date]) {
                showsByDate[date].forEach(time => {
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    timeSelect.appendChild(option);
                });
            }
        }

        function continueToSeats() {
            const movieId = document.getElementById('movieSelect').value;
            const date = document.getElementById('dateSelect').value;
            const time = document.getElementById('timeSelect').value;

            if (!movieId || !date || !time) {
                alert('Please select all options');
                return;
            }

            window.location.href = `/Seat/Select?movieId=${movieId}&date=${date}&time=${time}`;
        }
    </script>
}
