@{
    ViewData["Title"] = "Choose Show";
    var movieList = ViewBag.MovieList as List<MovieTheater.Models.Movie>;
    var selectedMovieId = ViewBag.SelectedMovieId as string;
}

<div class="container mt-5">
    <div class="card shadow p-4">
        <h2 class="text-center mb-4">🎬 Book Your Ticket</h2>

        <form id="bookingForm" novalidate>
            <div class="mb-4">
                <label for="movieSelect" class="form-label"><strong>Movie</strong></label>
                <select id="movieSelect" class="form-select">
                    <option value="">— Select Movie —</option>
                    @foreach (var m in movieList)
                    {
                        if (m.MovieId == selectedMovieId)
                        {
                            <option value="@m.MovieId" selected>@m.MovieNameEnglish</option>
                        }
                        else
                        {
                            <option value="@m.MovieId">@m.MovieNameEnglish</option>
                        }
                    }
                </select>
            </div>

            <div class="mb-4">
                <label for="dateSelect" class="form-label"><strong>Date</strong></label>
                <select id="dateSelect" class="form-select" disabled>
                    <option value="">— Select Date —</option>
                </select>
            </div>

            <div class="mb-4">
                <label for="timeSelect" class="form-label"><strong>Time</strong></label>
                <select id="timeSelect" class="form-select" disabled>
                    <option value="">— Select Time —</option>
                </select>
            </div>

                        <button type="button" id="bookBtn" class="btn btn-success w-100">
                            Continue to Seat Selection
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            const $movie = $('#movieSelect'),
                  $date  = $('#dateSelect'),
                  $time  = $('#timeSelect'),
                  $error = $('#errorMessage');

            $movie.on('change', function () {
                const movieId = $(this).val();
                $error.text('');
                $date.prop('disabled', true).html('<option value="">— Select Date —</option>');
                $time.prop('disabled', true).html('<option value="">— Select Time —</option>');

                if (!movieId) return;
                $.getJSON(`/Booking/GetDates?movieId=${movieId}`, dates => {
                    if (dates.length) {
                        dates.forEach(d => $date.append(`<option>${d}</option>`));
                        $date.prop('disabled', false);
                    }
                });
            });

            $date.on('change', function () {
                const movieId = $movie.val(),
                      date    = $(this).val();
                $error.text('');
                $time.prop('disabled', true).html('<option value="">— Select Time —</option>');

                if (!date) return;
                $.getJSON(`/Booking/GetTimes?movieId=${movieId}&date=${date}`, times => {
                    if (times.length) {
                        times.forEach(t => $time.append(`<option>${t}</option>`));
                        $time.prop('disabled', false);
                    }
                });
            });

            $('#bookBtn').on('click', function () {
                $error.text('');
                const movieId = $movie.val(),
                      date    = $date.val(),
                      time    = $time.val();

                if (!movieId) return $error.text('Please select a movie.');
                if (!date)    return $error.text('Please select a date.');
                if (!time)    return $error.text('Please select a time.');

                window.location.href = `/Seat/Select?movieId=${movieId}&date=${date}&time=${time}`;
            });

            var preselect = '@selectedMovieId';
            if (preselect) {
                $movie.val(preselect).trigger('change');
            }
        });
    </script>
}
