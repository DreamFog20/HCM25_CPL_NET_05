@{
    ViewData["Title"] = "Choose Show";
    var movieList = ViewBag.MovieList as List<MovieTheater.Models.Movie>;
    var selectedMovieId = ViewBag.SelectedMovieId as string;
    var showsByDate = ViewBag.ShowsByDate as Dictionary<string, List<string>>;
    ViewBag.CurrentStep = 1;
}
@Html.Partial("_BookingProgress")
<div class="booking-bg-custom"></div>
<div class="booking-bg-overlay"></div>
<div class="booking-content-wrapper">
    <div class="container mt-5 d-flex justify-content-center align-items-center" style="min-height:70vh;">
        <div class="booking-card-modern glass-card p-4 w-100" style="max-width: 480px;">
            <h2 class="text-center mb-4 booking-title"><i class="fas fa-ticket-alt me-2"></i>Book Your Ticket</h2>
            <form id="bookingForm" novalidate>
                <div class="mb-4">
                    <label for="movieSelect" class="form-label booking-label"><span class="label-icon">🎬</span> <strong>Movie</strong></label>
                    <select id="movieSelect" class="form-select booking-select" onchange="window.location.href='/Booking/TicketBooking?movieId=' + this.value">
                        <option value="">— Select Movie —</option>
                        @if (movieList != null)
                        {
                            foreach (var m in movieList)
                            {
                                if (m.MovieId == selectedMovieId)
                                {
                                    <option value="@m.MovieId" selected>@m.MovieNameEnglish</option>
                                }
                                else
                                {
                                    <option value="@m.MovieId">@m.MovieNameEnglish</option>
                                }
                            }
                        }
                    </select>
                </div>
                @if (!string.IsNullOrEmpty(selectedMovieId) && showsByDate != null)
                {
                    <div class="mb-4">
                        <label for="dateSelect" class="form-label booking-label"><span class="label-icon">🗓️</span> <strong>Date</strong></label>
                        <select id="dateSelect" class="form-select booking-select" onchange="updateVersions()">
                            <option value="">— Select Date —</option>
                            @{
                                var today = DateTime.Today;
                                foreach (var date in showsByDate.Keys.OrderBy(d => DateTime.ParseExact(d, "dd/MM/yyyy", null)))
                                {
                                    var parsedDate = DateTime.ParseExact(date, "dd/MM/yyyy", null);
                                    if (parsedDate >= today)
                                    {
                                        var value = parsedDate.ToString("yyyy-MM-dd");
                                        <option value="@value">@date</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="versionSelect" class="form-label booking-label"><span class="label-icon">🎞️</span> <strong>Version</strong></label>
                        <select id="versionSelect" class="form-select booking-select" disabled onchange="updateTimes()">
                            <option value="">— Select Version —</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="timeSelect" class="form-label booking-label"><span class="label-icon">⏰</span> <strong>Time</strong></label>
                        <select id="timeSelect" class="form-select booking-select" disabled>
                            <option value="">— Select Time —</option>
                        </select>
                    </div>
                    <button type="button" id="bookBtn" class="btn booking-btn-gradient w-100 mt-2" onclick="continueToSeats()">
                        <span>Continue to Seat Selection</span> <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                }
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const showsByDate = @Html.Raw(Json.Serialize(showsByDate));

        function updateVersions() {
            const movieId = document.getElementById('movieSelect').value;
            const date = document.getElementById('dateSelect').value;
            const versionSelect = document.getElementById('versionSelect');
            const timeSelect = document.getElementById('timeSelect');
            versionSelect.innerHTML = '<option value="">— Select Version —</option>';
            versionSelect.disabled = true;
            timeSelect.innerHTML = '<option value="">— Select Time —</option>';
            timeSelect.disabled = true;

            if (movieId && date) {
                fetch(`/Booking/GetVersions?movieId=${movieId}&date=${date}`)
                    .then(response => response.json())
                    .then(versions => {
                        if (versions.length > 0) {
                            versions.forEach(v => {
                                const option = document.createElement('option');
                                option.value = v.versionId;
                                option.textContent = v.versionName;
                                versionSelect.appendChild(option);
                            });
                            versionSelect.disabled = false;
                        }
                    });
            }
        }

        function updateTimes() {
            const movieId = document.getElementById('movieSelect').value;
            const date = document.getElementById('dateSelect').value;
            const versionId = document.getElementById('versionSelect').value;
            const timeSelect = document.getElementById('timeSelect');
            timeSelect.innerHTML = '<option value="">— Select Time —</option>';
            timeSelect.disabled = true;

            if (movieId && date && versionId) {
                fetch(`/Booking/GetTimes?movieId=${movieId}&date=${date}&versionId=${versionId}`)
                    .then(response => response.json())
                    .then(times => {
                        if (times.length > 0) {
                            times.forEach(time => {
                                const option = document.createElement('option');
                                option.value = time;
                                option.textContent = time;
                                timeSelect.appendChild(option);
                            });
                            timeSelect.disabled = false;
                        }
                    });
            }
        }

        function continueToSeats() {
            const movieId = document.getElementById('movieSelect').value;
            const date = document.getElementById('dateSelect').value;
            const versionId = document.getElementById('versionSelect').value;
            const time = document.getElementById('timeSelect').value;

            if (!movieId || !date || !versionId || !time) {
                alert('Please select all options');
                return;
            }

            const [year, month, day] = date.split('-');
            const formattedDate = `${day}/${month}/${year}`;

            window.location.href = `/Seat/Select?movieId=${movieId}&date=${formattedDate}&versionId=${versionId}&time=${time}`;
        }
    </script>
}